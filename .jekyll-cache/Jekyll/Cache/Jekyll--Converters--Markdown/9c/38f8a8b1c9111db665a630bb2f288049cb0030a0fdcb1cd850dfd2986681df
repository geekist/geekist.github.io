I"V—<p>ç”¨ Python å®ç°è‡ªåŠ¨æ‰¹é‡æ‰“åˆ†è¯„è®ºæŒ‡å®š CSDN è´¦å·å†…æ‰€æœ‰ä¸‹è½½è¿‡å¾…è¯„è®ºçš„èµ„æºã€‚</p>

<p>GitHub ä»“åº“åœ°å€ï¼š<a href="https://github.com/mzlogin/csdncommenter">https://github.com/mzlogin/csdncommenter</a></p>

<p>å¯é€šè¿‡ pip å®‰è£…è¿è¡Œï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip install csdncommenter
csdncommenter
</code></pre></div></div>

<h3 id="èƒŒæ™¯">èƒŒæ™¯</h3>

<p>CSDN è´¦å·è¿‡ä¸€æ®µæ—¶é—´å°±ä¼šç´¯ç§¯å‡ åä¸ªä¸‹è½½è¿‡ä½†æ˜¯æœªè¯„è®ºæ‰“åˆ†çš„èµ„æºï¼Œè™½ç„¶ç°åœ¨ä¸Šä¼ äº†ä¸€äº›èµ„æºä¾›åˆ«äººä¸‹è½½ååŸºæœ¬ä¸æ„ç§¯åˆ†ï¼Œä½†æ˜¯ä¸ºäº†å¯æŒç»­å‘å±•ï¼Œè¿˜æ˜¯æŠŠè¯„è®ºä¸€ä¸‹å°±èƒ½é¡ºæ‰‹æ‹¿äº†çš„è¿™ç§ç§¯åˆ†ä¸å®¢æ°”åœ°æ”¶å…¥å›Šä¸­å§ï¼ä¸è¿‡æ‰‹åŠ¨ä¸€ä¸ªä¸€ä¸ªå»è¯„è®ºçœŸçš„å¾ˆè›‹ç–¼â€¦â€¦ç‰¹åˆ«æ˜¯ CSDN è¿˜è®¾äº†ä¸¤ä¸ªè¯„è®ºé—´éš”ä¸èƒ½å°äº 60 ç§’ã€åˆšåˆšä¸‹è½½çš„èµ„æºååˆ†é’Ÿå†…ä¸èƒ½è¯„è®ºçš„é™åˆ¶ï¼Œè¯„è®ºå‡ åä¸ªå°±å¾—è‡³å°‘èŠ±ä¸ªå‡ ååˆ†é’ŸæŠ˜è…¾ï¼Œæ‰€ä»¥æƒ³æƒ³è¿™ç§è€—æ—¶ã€æ— è„‘çš„æ´»è¿˜æ˜¯äº¤ç»™ç¨‹åºæ¥å®Œæˆå§ã€‚</p>

<p>å¯¹äºè¿™ç±»æ¨¡æ‹Ÿ HTTP è¯·æ±‚ç„¶åå¯èƒ½é¢‘ç¹ç”¨åˆ°é¡µé¢è§£æå’Œæ­£åˆ™è¡¨è¾¾å¼ä¹‹ç±»çš„æ´»ï¼Œç”¨ C++ å†™è¿˜æ˜¯æœ‰ç‚¹è›‹ç–¼çš„ï¼Œç”¨æˆ‘é‚£åŠç”Ÿä¸ç†Ÿçš„ Python ç»ƒç»ƒæ‰‹æ­£åˆé€‚ã€‚</p>

<p>é‚åœ¨ GitHub ä¸Šå»ºäº†ä¸ªä»“åº“å¼€å·¥ï¼Œåœ°å€åœ¨è¿™é‡Œï¼š<a href="https://github.com/mzlogin/csdncommenter">https://github.com/mzlogin/csdncommenter</a>ã€‚</p>

<blockquote>
  <p>Update 2016/08/10ï¼šå½“å‰ CSDN è²Œä¼¼å·²ç»å–æ¶ˆäº†è¯„è®ºè¿”ç§¯åˆ†çš„è§„åˆ™ï¼Œæˆ‘çœ‹äº†ä¸‹æˆ‘çš„å¾—åˆ†è®°å½•ï¼Œæœ€è¿‘ä¸€æ¬¡è¯„è®ºå¾—åˆ†æ˜¯åœ¨ 2015/11/15ã€‚</p>
</blockquote>

<h3 id="åˆ†æ">åˆ†æ</h3>

<p>ä½¿ç”¨ Fiddler æŠŠ<em>ç™»å½• - åˆ°å¾…è¯„è®ºé¡µé¢ - è¯„è®º</em>çš„å®Œæ•´æµç¨‹æŠ“äº†ä¸€ä¸‹ï¼Œæ•´ç†ç¨‹åºé€»è¾‘å¤§è‡´å¦‚ä¸‹ï¼š</p>

<p><em>æ³¨ï¼šå¦‚ä¸‹ HTTP è¯·æ±‚å‡ä½¿ç”¨åŒä¸€ä¸ª SESSIONã€‚</em></p>

<ol>
  <li>
    <p>æ‰‹åŠ¨è¾“å…¥ CSDN çš„ç”¨æˆ·åå’Œå¯†ç ã€‚</p>
  </li>
  <li>
    <p>ç”¨ <code class="language-plaintext highlighter-rouge">GET</code> æ–¹æ³•ä» https://passport.csdn.net/account/login é¡µé¢è·å– <code class="language-plaintext highlighter-rouge">lt</code>ã€<code class="language-plaintext highlighter-rouge">execution</code> å’Œ <code class="language-plaintext highlighter-rouge">_eventId</code> ç­‰å‚æ•°ã€‚</p>
  </li>
  <li>
    <p>å°†ç¬¬ 1 æ­¥ä¸­çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œè¿˜æœ‰ç¬¬ 2 æ­¥ä¸­å¾—åˆ°çš„å‚æ•° <code class="language-plaintext highlighter-rouge">POST</code> ç»™ https://passport.csdn.net/account/login ï¼Œä» Response ä¸­åˆ¤æ–­æ˜¯å¦ç™»å½•æˆåŠŸâ€”â€”æˆ‘é‡‡ç”¨çš„ä¾æ®æ˜¯ status_code ä¸º 200 ä¸” Reponse å†…å®¹ä¸­æœ‰ <code class="language-plaintext highlighter-rouge">lastLoginIP</code>ã€‚</p>
  </li>
  <li>
    <p>ç”¨ <code class="language-plaintext highlighter-rouge">GET</code> æ–¹æ³•ä» http://download.csdn.net/my/downloads é¡µé¢è·å–å·²ä¸‹è½½èµ„æºæ€»é¡µæ•°ã€‚ä»æœ€åä¸€ä¸ª <code class="language-plaintext highlighter-rouge">pageliststy</code> çš„ <code class="language-plaintext highlighter-rouge">href</code> ä¸­å¾—åˆ°ã€‚</p>
  </li>
  <li>
    <p>æ ¹æ®ç¬¬ 4 æ­¥ä¸­å¾—åˆ°çš„æ€»é¡µæ•°ï¼Œæ ¹æ®æ¯ä¸ªé¡µé¢ num æ‹¼å¾— url ä¸º http://download.csdn.net/my/downloads/num ï¼Œä½¿ç”¨ <code class="language-plaintext highlighter-rouge">GET</code> æ–¹æ³•è®¿é—®ä¹‹æ‹¿åˆ°è¯¥é¡µé¢ä¸­æ‰€æœ‰å¾…è¯„è®ºèµ„æº IDã€‚ä»æ‰€æœ‰ <code class="language-plaintext highlighter-rouge">class="btn-comment"</code> çš„ <code class="language-plaintext highlighter-rouge">a</code> æ ‡ç­¾çš„ <code class="language-plaintext highlighter-rouge">href</code> ä¸­å¾—åˆ°ã€‚</p>
  </li>
  <li>
    <p>åœ¨è¿›è¡Œç¬¬ 5 æ­¥çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœ num ä¸º 1 çš„é¡µé¢é‡Œæœ‰ <code class="language-plaintext highlighter-rouge">&lt;span class="btn-comment"&gt;</code> å­˜åœ¨ï¼Œé‚£è¯´æ˜å­˜åœ¨ 10 åˆ†é’Ÿä»¥å†…ä¸‹è½½ï¼Œæš‚æ—¶ä¸èƒ½è¯„è®ºçš„èµ„æºï¼Œè¿™æ—¶å¾ªç¯æ£€æŸ¥æœ€å¤š 11 æ¬¡ï¼Œæ¯æ¬¡æ£€æŸ¥å®Œå¦‚æœå‘ç°è¿˜éœ€è¦ç­‰å¾…å°±è¿‡ä¸€åˆ†é’Ÿå†æ£€æŸ¥ï¼Œè¿›åˆ°ä¸å†éœ€è¦ç­‰å¾…æˆ–è€…è¶…è¿‡ 11 æ¬¡ä¸ºæ­¢ã€‚</p>
  </li>
  <li>
    <p>å¯¹ç¬¬ 5 æ­¥ä¸­å¾—åˆ°çš„æ‰€æœ‰å¾…è¯„è®ºèµ„æº ID ä¾æ¬¡è¿›è¡Œé—´éš”è‡³å°‘ 60S çš„æ‰“åˆ†è¯„è®ºï¼Œæ ¹æ®èµ„æºçš„ç°æœ‰è¯„æ˜Ÿæ‰“åˆ†ï¼Œä¸å¯¹èµ„æºè¯„åˆ†é€ æˆä¸è‰¯å½±å“ã€‚æ ¹æ®æ‰“å‡ºçš„ 1 åˆ° 5 æ˜Ÿï¼Œå¯¹åº”ä¸€å¥è‹±æ–‡çŸ­å¥è¯„è®ºã€‚å‡ºä¹æˆ‘æ„æ–™çš„æ˜¯è¯„è®ºè¿™ä¸€æ­¥ç«Ÿç„¶ä¹Ÿæ˜¯ç”¨ <code class="language-plaintext highlighter-rouge">GET</code> å°±å¯ä»¥åšï¼Œhttp://download.csdn.net/index.php/comment/post_comment åé¢å¸¦ä¸Š <code class="language-plaintext highlighter-rouge">sourceid</code>ã€<code class="language-plaintext highlighter-rouge">content</code>ï¼ˆè¯„è®ºå†…å®¹ï¼‰ã€<code class="language-plaintext highlighter-rouge">rating</code>ï¼ˆæ‰“åˆ†ï¼‰å’Œ <code class="language-plaintext highlighter-rouge">t</code>ï¼ˆæ—¶é—´æˆ³ï¼‰å‚æ•°å°±å¯ä»¥ã€‚è¯„è®ºæˆåŠŸä¼šè¿”å› <code class="language-plaintext highlighter-rouge">({"succ":1})</code>ï¼Œå¤±è´¥ä¼šè¿”å›ã€Œä¸¤æ¬¡è¯„è®ºéœ€è¦é—´éš” 60 ç§’ã€ã€ã€Œæ‚¨å·²ç»å‘è¡¨è¿‡è¯„è®ºã€ç­‰ä¹‹ç±»çš„ <code class="language-plaintext highlighter-rouge">msg</code>ã€‚</p>

    <p>è·å–èµ„æºçš„ç°æœ‰è¯„æ˜Ÿçš„æ–¹æ³•æ˜¯ä» http://download.csdn.net/detail/&lt;èµ„æºæ‰€æœ‰è€… ID&gt;/&lt;èµ„æº ID&gt; é¡µé¢è·å– <code class="language-plaintext highlighter-rouge">&lt;span style="width:75px" class="star-yellow"&gt;&lt;/span&gt;</code> è¿™ä¸€æ®µå†…å®¹ï¼Œå…¶ä¸­çš„ <code class="language-plaintext highlighter-rouge">75px</code> è¡¨ç¤ºä¸ºäº”æ˜Ÿï¼Œå¦‚æœæ˜¯ <code class="language-plaintext highlighter-rouge">0px</code> è¡¨ç¤ºä¸ºé›¶æ˜Ÿï¼Œå³æ¯åŠ ä¸€æ˜Ÿå¢åŠ  15pxã€‚</p>
  </li>
</ol>

<p>æœ€ç»ˆè¿è¡Œæˆªå›¾å¦‚ä¸‹ï¼š</p>

<p><img src="/images/posts/python/csdncommenter.png" alt="CSDN è‡ªåŠ¨æ‰¹é‡æ‰“åˆ†è¯„è®º" /></p>

<p>ç¡®è®¤è¿™ç§æ–¹å¼èƒ½æœ‰æ•ˆæ‹¿åˆ° CSDN çš„åˆ†æ•°ï¼š</p>

<p><img src="/images/posts/python/csdnscore.png" alt="CSDN è‡ªåŠ¨è¯„è®ºå¾—åˆ†" /></p>

<h3 id="æ€»ç»“">æ€»ç»“</h3>

<ol>
  <li>ç”¨ Python å¹²è¿™ç§ç±»å‹çš„æ´»è¿˜æ˜¯å¾ˆæœ‰ä¼˜åŠ¿çš„ï¼Œrequests å’Œ BeautifulSoup ç®€ç›´ç¥å™¨å•Šï¼</li>
  <li>æˆ‘é‚£ç‚¹è¹©è„šçš„ Python åº•å­ä¹‹æ‰€ä»¥èƒ½è¿˜æ¯”è¾ƒé¡ºåˆ©åœ°æŠŠè¿™ä¸ªæµç¨‹å†™ä¸‹æ¥ï¼Œå®é™…ä¸Šä¹Ÿå¾—äº CSDN å¯¹è¯·æ±‚çš„éªŒè¯ç›¸å¯¹è¾ƒæ¾ï¼Œæ¯”å¦‚åƒæˆ‘ä»£ç é‡Œé‚£æ ·å†™ï¼Œ <code class="language-plaintext highlighter-rouge">User-Agent</code> æ˜¯å¸¦æœ‰ <code class="language-plaintext highlighter-rouge">Python</code> å­—æ ·çš„ï¼Œè€Œä¸”å¾ˆæ˜¾ç„¶ä¸æ˜¯æµè§ˆå™¨åœ¨è®¿é—®ï¼Œä½† CSDN å¹¶æœªå¯¹æ­¤ä½œé™åˆ¶ã€‚</li>
</ol>

<h3 id="æºç ">æºç </h3>

<p>æ²¡æœ‰æ‰¾åˆ°ä» Github Pages å¼•ç”¨ Github ä»“åº“é‡Œçš„æºç çš„æ–¹æ³•<del>ï¼Œæ‰€ä»¥æŠŠ py æ–‡ä»¶æ”¾åˆ°ä¸€ä¸ª gist é‡Œäº†ï¼Œå¼•ç”¨å¦‚ä¸‹</del>ï¼š</p>

<p>ï¼ˆGist å‰å‡ å¤©è¢«ä¼Ÿå¤§çš„å¢™å°äº†ï¼Œè¿˜æ˜¯ç›´æ¥è´´ä¸Šä»£ç å§ã€‚2014/11/5 updateï¼‰</p>

<p>ï¼ˆGitHub ä»“åº“ï¼š<a href="https://github.com/mzlogin/csdncommenter">mzlogin/csdncommenter</a>ï¼Œç°åœ¨å¯ä»¥é€šè¿‡ pip å®‰è£…ä½¿ç”¨äº†  <code class="language-plaintext highlighter-rouge">pip install csdncommenter</code>  ç„¶å  <code class="language-plaintext highlighter-rouge">csdncommenter</code>ã€‚2015/10/27 updateï¼‰</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># File   : csdncommenter.py
# Author : Zhuang Ma
# E-mail : chumpma(at)gmail.com
# Website: https://mazhuang.org
# Date   : 2016-07-26
</span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">BeautifulSoup</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="k">class</span> <span class="nc">CsdnCommenter</span><span class="p">():</span>
    <span class="s">"""Csdn operator"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">sess</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""login and keep session"""</span>
        <span class="n">username</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">'username: '</span><span class="p">)</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">.</span><span class="n">getpass</span><span class="p">(</span><span class="s">'password: '</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">'https://passport.csdn.net/account/login'</span>
        <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">getUrlContent</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">sess</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">html</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>

        <span class="n">lt</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">getElementValue</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="s">'name'</span><span class="p">,</span> <span class="s">'lt'</span><span class="p">)</span>
        <span class="n">execution</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">getElementValue</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="s">'name'</span><span class="p">,</span> <span class="s">'execution'</span><span class="p">)</span>
        <span class="n">_eventId</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">getElementValue</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="s">'name'</span><span class="p">,</span> <span class="s">'_eventId'</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">'username'</span> <span class="p">:</span> <span class="n">username</span><span class="p">,</span>
                <span class="s">'password'</span> <span class="p">:</span> <span class="n">password</span><span class="p">,</span>
                <span class="s">'lt'</span> <span class="p">:</span> <span class="n">lt</span><span class="p">,</span>
                <span class="s">'execution'</span> <span class="p">:</span> <span class="n">execution</span><span class="p">,</span>
                <span class="s">'_eventId'</span> <span class="p">:</span> <span class="n">_eventId</span>
                <span class="p">}</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">sess</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
<span class="c1">#             traceback.print_exc()
</span>            <span class="k">pass</span>

        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">isLoginSuccess</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">autoComment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""main handler"""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">getSourceItems</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'No source can comment!'</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">print</span><span class="p">(</span><span class="s">'Total %d source(s) wait for comment.'</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">sourceitems</span><span class="p">))</span>

        <span class="n">nhandled</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">sourceid</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">sourceitems</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">left</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">sourceitems</span><span class="p">)</span> <span class="o">-</span> <span class="n">nhandled</span>

            <span class="n">sec</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">61</span><span class="p">,</span><span class="mi">71</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Wait %d seconds for start. %s source(s) left.'</span> <span class="o">%</span> <span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">left</span><span class="p">))</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span>

            <span class="bp">self</span><span class="p">.</span><span class="n">comment</span><span class="p">(</span><span class="n">sourceid</span><span class="p">)</span>
            <span class="n">nhandled</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">print</span><span class="p">(</span><span class="s">'Finished!'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getSourceItems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""get (sourceid,username) couples wait for comment"""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">sourceitems</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">pagecount</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">getPageCount</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pagecount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">print</span><span class="p">(</span><span class="s">'Pagecount is %d.'</span> <span class="o">%</span> <span class="n">pagecount</span><span class="p">)</span>

        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s">'/detail/([^/]+)/(\d+)#comment'</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pagecount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">waitUncommentableSourceIfNecessary</span><span class="p">()</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s">'http://download.csdn.net/my/downloads/%d'</span> <span class="o">%</span> <span class="n">n</span>
            <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">getUrlContent</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">sess</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">html</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
            <span class="n">sourcelist</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">'a'</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s">'class'</span> <span class="p">:</span> <span class="s">'btn-comment'</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">sourcelist</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">sourcelist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sourcelist</span><span class="p">:</span>
                <span class="n">href</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'href'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">href</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">rematch</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="n">href</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">rematch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">sourceitems</span><span class="p">[</span><span class="n">rematch</span><span class="p">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">rematch</span><span class="p">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">sourceitems</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">waitUncommentableSourceIfNecessary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""souce cannot comment within 10 minutes after download"""</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">'http://download.csdn.net/my/downloads/1'</span>
        <span class="n">maxMinutes</span> <span class="o">=</span> <span class="mi">11</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxMinutes</span><span class="p">):</span>
            <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">getUrlContent</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">sess</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">html</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
            <span class="n">sourcelist</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">'span'</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s">'class'</span> <span class="p">:</span> <span class="s">'btn-comment'</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">sourcelist</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">sourcelist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">'None uncommentable source now!'</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Waiting for uncommentable source count down %d minutes.'</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxMinutes</span><span class="o">-</span><span class="n">i</span><span class="p">))</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getPageCount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""get downloaded resources page count"""</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">'http://download.csdn.net/my/downloads'</span>
        <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">getUrlContent</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">sess</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">html</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Get pagecount failed'</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>

        <span class="n">pagelist</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">'a'</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s">'class'</span> <span class="p">:</span> <span class="s">'pageliststy'</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">pagelist</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">pagelist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="n">lasthref</span> <span class="o">=</span> <span class="n">pagelist</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">pagelist</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="s">'href'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lasthref</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="nb">str</span><span class="p">.</span><span class="n">isdigit</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lasthref</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sourceid</span><span class="p">):</span>
        <span class="s">"""comment per source"""</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'sourceid %s commenting...'</span> <span class="o">%</span> <span class="n">sourceid</span><span class="p">)</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s">'It just soso, but thank you all the same.'</span><span class="p">,</span>
                <span class="s">'Neither good nor bad.'</span><span class="p">,</span>
                <span class="s">'It is a nice resource, thanks for share.'</span><span class="p">,</span>
                <span class="s">'It is useful for me, thanks.'</span><span class="p">,</span>
                <span class="s">'I have looking this for long, thanks.'</span>
                <span class="p">]</span>
        <span class="n">rating</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">getSourceRating</span><span class="p">(</span><span class="n">sourceid</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'current rating is %d.'</span> <span class="o">%</span> <span class="n">rating</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rating</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># nobody comments
</span>            <span class="n">rating</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">contents</span><span class="p">[</span><span class="n">rating</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="s">'%d'</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="n">paramsmap</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">'sourceid'</span> <span class="p">:</span> <span class="n">sourceid</span><span class="p">,</span>
                <span class="s">'content'</span> <span class="p">:</span> <span class="n">content</span><span class="p">,</span>
                <span class="s">'rating'</span> <span class="p">:</span> <span class="n">rating</span><span class="p">,</span>
                <span class="s">'t'</span> <span class="p">:</span> <span class="n">t</span>
                <span class="p">}</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">urllib</span><span class="p">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">paramsmap</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">'http://download.csdn.net/index.php/comment/post_comment?%s'</span> <span class="o">%</span> <span class="n">params</span>
        <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">getUrlContent</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">sess</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">html</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">html</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'({"succ":1})'</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'sourceid %s comment failed! response is %s.'</span> <span class="o">%</span> <span class="p">(</span><span class="n">sourceid</span><span class="p">,</span> <span class="n">html</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'sourceid %s comment succeed!'</span> <span class="o">%</span> <span class="n">sourceid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getSourceRating</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sourceid</span><span class="p">):</span>
        <span class="s">"""get current source rating"""</span>
        <span class="n">rating</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">'http://download.csdn.net/detail/%s/%s'</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">sourceitems</span><span class="p">[</span><span class="n">sourceid</span><span class="p">],</span> <span class="n">sourceid</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">getUrlContent</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">sess</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">html</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rating</span>

        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="n">ratingspan</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">'span'</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s">'class'</span><span class="p">:</span> <span class="s">'star-yellow'</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">ratingspan</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ratingspan</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rating</span>

        <span class="n">ratingstyle</span> <span class="o">=</span> <span class="n">ratingspan</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="s">'style'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ratingstyle</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rating</span>

        <span class="n">rating</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="nb">str</span><span class="p">.</span><span class="n">isdigit</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ratingstyle</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">15</span>
        <span class="k">return</span> <span class="n">rating</span>


    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">getElementValue</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="n">element_name</span><span class="p">,</span> <span class="n">element_value</span><span class="p">):</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="n">element_name</span> <span class="p">:</span> <span class="n">element_value</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">element</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'value'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">isLoginSuccess</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'lastLoginIP'</span><span class="p">)</span>

    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">getUrlContent</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">html</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">html</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span>
        <span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="c1">#             traceback.print_exc()
</span>            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">html</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">csdn</span> <span class="o">=</span> <span class="n">CsdnCommenter</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">csdn</span><span class="p">.</span><span class="n">login</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Login failed! Please try again.'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Login succeed!'</span><span class="p">)</span>

    <span class="n">csdn</span><span class="p">.</span><span class="n">autoComment</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>
:ET