I"®<h3 id="éœ€æ±‚">éœ€æ±‚</h3>

<p>ä¸€ä¸ª EXE åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼ˆè¢«ï¼‰æ”¹åäº†ï¼Œéœ€è¦å‡†ç¡®åœ°è·å–å®ƒçš„æ–‡ä»¶åã€‚</p>

<h3 id="å°è¯•">å°è¯•</h3>

<p>åŸæœ¬ä»¥ä¸ºè¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ CASEï¼Œç›´æ¥ç”¨ GetModuleFileName ä¸å°±è¡Œäº†å—ï¼Ÿç»“æœè¿˜çœŸä¸å¦‚æˆ‘æ‰€æƒ³ã€‚æ— è®ºç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­è¢«æ”¹åæˆä»€ä¹ˆæ ·å­ï¼ŒGetModuleFileName è¿”å›çš„éƒ½æ˜¯ EXE å¼€å§‹è¿è¡Œæ—¶çš„åå­—ã€‚ç„¶ååˆå°è¯•äº† GetProcessImageFileNameï¼Œä¹Ÿæ˜¯å¦‚æ­¤ï¼Œç›´åˆ°æœ€åæ‰¾åˆ°äº† QueryFullProcessImageNameã€‚</p>

<h3 id="ç¤ºä¾‹ä»£ç ">ç¤ºä¾‹ä»£ç </h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;Windows.h&gt;
#include &lt;Psapi.h&gt;
#include &lt;stdio.h&gt;
</span>
<span class="cp">#pragma comment(lib, "Psapi.lib")
</span>
<span class="kt">void</span> <span class="nf">OutputSelfpath</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">szFile</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">GetModuleFileName</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">szFile</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"GetModuleFileName:</span><span class="se">\n\r</span><span class="s">%s</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">szFile</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">szFile</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">);</span>

	<span class="n">HANDLE</span> <span class="n">hProcess</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_ALL_ACCESS</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">GetCurrentProcessId</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hProcess</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"OpenProcess failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">DWORD</span> <span class="n">dwRet</span> <span class="o">=</span> <span class="n">GetProcessImageFileName</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">szFile</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dwRet</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"GetProcessImageFileName:</span><span class="se">\n\r</span><span class="s">%s</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">szFile</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"GetProcessImageFileName failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="p">}</span>

        <span class="n">memset</span><span class="p">(</span><span class="n">szFile</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">);</span>
		<span class="n">DWORD</span> <span class="n">dwSize</span> <span class="o">=</span> <span class="n">MAX_PATH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">QueryFullProcessImageName</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">szFile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwSize</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"QueryFullProcessImageName:</span><span class="se">\n\r</span><span class="s">%s</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">szFile</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"QueryFullProcessImageName failed</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">szFile</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pszFile</span> <span class="o">=</span> <span class="s">"ConsoleTest.exe"</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pszNewFile</span> <span class="o">=</span> <span class="s">"ConsoleTest_bak.exe"</span><span class="p">;</span>
	<span class="n">remove</span><span class="p">(</span><span class="n">pszNewFile</span><span class="p">);</span>

	<span class="n">OutputSelfpath</span><span class="p">();</span>

	<span class="kt">int</span> <span class="n">nRet</span> <span class="o">=</span> <span class="n">rename</span><span class="p">(</span><span class="n">pszFile</span><span class="p">,</span> <span class="n">pszNewFile</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">nRet</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"rename file failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"################### after rename ###################</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">OutputSelfpath</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">system</span><span class="p">(</span><span class="s">"pause"</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="è¿è¡Œç»“æœ">è¿è¡Œç»“æœ</h3>

<p><img src="/images/posts/windows/queryfullprocessimagename.png" alt="QueryFullProcessImageName" /></p>

<h3 id="æ€è€ƒ">æ€è€ƒ</h3>

<p>ç°è±¡ä¸Šè®²å°±æ˜¯å¦‚æ­¤äº†ï¼Œè¿™å‡ ä¸ª API çš„æœ¬è´¨åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¾…ç»­ã€‚</p>
:ET