I"†J<p>æœ¬ç³»åˆ—æ–‡ç« åœ¨ <a href="https://github.com/mzlogin/rtfsc-android">https://github.com/mzlogin/rtfsc-android</a> æŒç»­æ›´æ–°ä¸­ï¼Œæ¬¢è¿æœ‰å…´è¶£çš„ç«¥é‹ä»¬å…³æ³¨ã€‚</p>

<p><img src="/images/posts/android/toast.png" alt="" /></p>

<p>ï¼ˆå›¾ from Android Developersï¼‰</p>

<p>Toast æ˜¯ Android å¼€å‘é‡Œè¾ƒå¸¸ç”¨çš„ä¸€ä¸ªç±»äº†ï¼Œæœ‰æ—¶å€™ç”¨å®ƒç»™ç”¨æˆ·å¼¹æç¤ºä¿¡æ¯å’Œç•Œé¢åé¦ˆï¼Œæœ‰æ—¶å€™ç”¨å®ƒæ¥ä½œä¸ºè¾…åŠ©è°ƒè¯•çš„æ‰‹æ®µã€‚ç”¨å¾—å¤šäº†ï¼Œè‡ªç„¶æƒ³å¯¹å…¶è¡¨å±‚ä¹‹ä¸‹çš„è¿è¡Œæœºåˆ¶æœ‰æ‰€äº†è§£ï¼Œæ‰€ä»¥åœ¨æ­¤å°†å®ƒé€‰ä¸ºæˆ‘çš„ç¬¬ä¸€ä¸ª RTFSC Rootsã€‚</p>

<p>æœ¬ç¯‡é‡‡ç”¨çš„è®°å½•æ–¹å¼æ˜¯å…ˆå¯¹å®ƒæœ‰ä¸ªæ•´ä½“çš„äº†è§£ï¼Œç„¶åæå‡ºä¸€äº›é—®é¢˜ï¼Œå†é€šè¿‡é˜…è¯»æºç ï¼Œå¯¹é—®é¢˜è¿›è¡Œä¸€ä¸€è§£è¯»è€Œåå¾—å‡ºç­”æ¡ˆã€‚</p>

<p>æœ¬æ–‡ä½¿ç”¨çš„å·¥å…·ä¸æºç ä¸ºï¼šChromeã€æ’ä»¶ insight.ioã€GitHub é¡¹ç›® <a href="https://github.com/aosp-mirror/platform_frameworks_base">aosp-mirror/platform_frameworks_base</a></p>

<p><strong>ç›®å½•</strong></p>

<!-- vim-markdown-toc GFM -->

<ul>
  <li><a href="#toast-å°è±¡">Toast å°è±¡</a></li>
  <li><a href="#æå‡ºé—®é¢˜">æå‡ºé—®é¢˜</a></li>
  <li><a href="#è§£ç­”é—®é¢˜">è§£ç­”é—®é¢˜</a>
    <ul>
      <li><a href="#toast-çš„è¶…æ—¶æ—¶é—´">Toast çš„è¶…æ—¶æ—¶é—´</a></li>
      <li><a href="#èƒ½ä¸èƒ½å¼¹ä¸€ä¸ªæ—¶é—´è¶…é•¿çš„-toast">èƒ½ä¸èƒ½å¼¹ä¸€ä¸ªæ—¶é—´è¶…é•¿çš„ Toastï¼Ÿ</a></li>
      <li><a href="#toast-èƒ½ä¸èƒ½åœ¨é-ui-çº¿ç¨‹è°ƒç”¨">Toast èƒ½ä¸èƒ½åœ¨é UI çº¿ç¨‹è°ƒç”¨ï¼Ÿ</a></li>
      <li><a href="#åº”ç”¨åœ¨åå°æ—¶èƒ½ä¸èƒ½-toast">åº”ç”¨åœ¨åå°æ—¶èƒ½ä¸èƒ½ Toastï¼Ÿ</a></li>
      <li><a href="#toast-æ•°é‡æœ‰æ²¡æœ‰é™åˆ¶">Toast æ•°é‡æœ‰æ²¡æœ‰é™åˆ¶ï¼Ÿ</a></li>
      <li><a href="#toastmaketextshow-å…·ä½“éƒ½åšäº†äº›ä»€ä¹ˆ"><code class="language-plaintext highlighter-rouge">Toast.makeText(â€¦).show()</code> å…·ä½“éƒ½åšäº†äº›ä»€ä¹ˆï¼Ÿ</a></li>
    </ul>
  </li>
  <li><a href="#æ€»ç»“">æ€»ç»“</a>
    <ul>
      <li><a href="#è¡¥å……åçš„-toast-çŸ¥è¯†ç‚¹åˆ—è¡¨">è¡¥å……åçš„ Toast çŸ¥è¯†ç‚¹åˆ—è¡¨</a></li>
      <li><a href="#é—ç•™çŸ¥è¯†ç‚¹">é—ç•™çŸ¥è¯†ç‚¹</a></li>
      <li><a href="#æœ¬ç¯‡ç”¨åˆ°çš„æºç åˆ†ææ–¹æ³•">æœ¬ç¯‡ç”¨åˆ°çš„æºç åˆ†ææ–¹æ³•</a></li>
    </ul>
  </li>
  <li><a href="#åè¯">åè¯</a></li>
</ul>

<!-- vim-markdown-toc -->

<h2 id="toast-å°è±¡">Toast å°è±¡</h2>

<p>é¦–å…ˆæˆ‘ä»¬ä» Toast ç±»çš„ <a href="1">å®˜æ–¹æ–‡æ¡£</a> å’Œ <a href="2">API æŒ‡å—</a> ä¸­å¯ä»¥å¾—å‡ºå®ƒå…·å¤‡å¦‚ä¸‹ç‰¹æ€§ï¼š</p>

<ol>
  <li>
    <p>Toast ä¸æ˜¯ Viewï¼Œå®ƒç”¨äºå¸®åŠ©åˆ›å»ºå¹¶å±•ç¤ºåŒ…å«ä¸€æ¡å°æ¶ˆæ¯çš„ Viewï¼›</p>
  </li>
  <li>
    <p>å®ƒçš„è®¾è®¡ç†å¿µæ˜¯å°½é‡ä¸æƒ¹çœ¼ï¼Œä½†åˆèƒ½å±•ç¤ºæƒ³è®©ç”¨æˆ·çœ‹åˆ°çš„ä¿¡æ¯ï¼›</p>
  </li>
  <li>
    <p>è¢«å±•ç¤ºæ—¶ï¼Œæµ®åœ¨åº”ç”¨ç•Œé¢ä¹‹ä¸Šï¼›</p>
  </li>
  <li>
    <p>æ°¸è¿œä¸ä¼šè·å–åˆ°ç„¦ç‚¹ï¼›</p>
  </li>
  <li>
    <p>å¤§å°å–å†³äºæ¶ˆæ¯çš„é•¿åº¦ï¼›</p>
  </li>
  <li>
    <p>è¶…æ—¶åä¼šè‡ªåŠ¨æ¶ˆå¤±ï¼›</p>
  </li>
  <li>
    <p>å¯ä»¥è‡ªå®šä¹‰æ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„ä½ç½®ï¼ˆé»˜è®¤å·¦å³å±…ä¸­æ˜¾ç¤ºåœ¨é è¿‘å±å¹•åº•éƒ¨çš„ä½ç½®ï¼‰ï¼›</p>
  </li>
  <li>
    <p>å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰å¸ƒå±€ï¼Œä¹Ÿåªæœ‰åœ¨è‡ªå®šä¹‰å¸ƒå±€çš„æ—¶å€™æ‰éœ€è¦ç›´æ¥è°ƒç”¨ Toast çš„æ„é€ æ–¹æ³•ï¼Œå…¶å®ƒæ—¶å€™éƒ½æ˜¯ä½¿ç”¨ makeText æ–¹æ³•æ¥åˆ›å»º Toastï¼›</p>
  </li>
  <li>
    <p>Toast å¼¹å‡ºåå½“å‰ Activity ä¼šä¿æŒå¯è§æ€§å’Œå¯äº¤äº’æ€§ï¼›</p>
  </li>
  <li>
    <p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">cancel</code> æ–¹æ³•å¯ä»¥ç«‹å³å°†å·²æ˜¾ç¤ºçš„ Toast å…³é—­ï¼Œè®©æœªæ˜¾ç¤ºçš„ Toast ä¸å†æ˜¾ç¤ºï¼›</p>
  </li>
  <li>
    <p>Toast ä¹Ÿç®—æ˜¯ä¸€ä¸ªã€Œé€šçŸ¥ã€ï¼Œå¦‚æœå¼¹å‡ºçŠ¶æ€æ¶ˆæ¯åæœŸæœ›å¾—åˆ°ç”¨æˆ·å“åº”ï¼Œåº”è¯¥ä½¿ç”¨ Notificationã€‚</p>
  </li>
</ol>

<p>ä¸çŸ¥é“ä½ çœ‹åˆ°è¿™ä¸ªåˆ—è¡¨ï¼Œæ˜¯å¦å­¦åˆ°äº†æ–°çŸ¥è¯†æˆ–è€…æ˜ç¡®äº†ä»¥å‰ä¸ç¡®å®šçš„ä¸œè¥¿ï¼Œåæ­£æˆ‘åœ¨æ•´ç†åˆ—è¡¨çš„æ—¶å€™æ˜¯æœ‰çš„ã€‚</p>

<h2 id="æå‡ºé—®é¢˜">æå‡ºé—®é¢˜</h2>

<p>æ ¹æ®ä»¥ä¸Šç‰¹æ€§ï¼Œå†ç»“åˆå¹³æ—¶å¯¹ Toast çš„ä½¿ç”¨ï¼Œæå‡ºå¦‚ä¸‹é—®é¢˜æ¥ç»§ç»­æœ¬æ¬¡æºç åˆ†æä¹‹æ—…ï¼ˆå¤§è‡´ç”±æ˜“åˆ°éš¾æ’åˆ—ï¼Œåæ–‡ç”¨ å° demo æˆ–è€…æºç åˆ†ææ¥è§£ç­”ï¼‰ï¼š</p>

<ol>
  <li>
    <p>Toast çš„è¶…æ—¶æ—¶é—´å…·ä½“æ˜¯å¤šå°‘ï¼Ÿ</p>
  </li>
  <li>
    <p>èƒ½ä¸èƒ½å¼¹ä¸€ä¸ªæ—¶é—´è¶…é•¿çš„ Toastï¼Ÿ</p>
  </li>
  <li>
    <p>Toast èƒ½ä¸èƒ½åœ¨é UI çº¿ç¨‹è°ƒç”¨ï¼Ÿ</p>
  </li>
  <li>
    <p>åº”ç”¨åœ¨åå°æ—¶èƒ½ä¸èƒ½ Toastï¼Ÿ</p>
  </li>
  <li>
    <p>Toast æ•°é‡æœ‰æ²¡æœ‰é™åˆ¶ï¼Ÿ</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Toast.makeText(â€¦).show()</code> å…·ä½“éƒ½åšäº†äº›ä»€ä¹ˆï¼Ÿ</p>
  </li>
</ol>

<h2 id="è§£ç­”é—®é¢˜">è§£ç­”é—®é¢˜</h2>

<h3 id="toast-çš„è¶…æ—¶æ—¶é—´">Toast çš„è¶…æ—¶æ—¶é—´</h3>

<p>ç”¨è¿™æ ·çš„ä¸€ä¸ªé—®é¢˜å¼€å§‹ã€ŒAndroid æºç åˆ†æã€ï¼ŒçœŸçš„å¥½æ€•è¢«æ‰“æ­»â€¦â€¦å¤§éƒ¨åˆ†äººéƒ½ä¼šå—¤ä¹‹ä»¥é¼»ï¼šAre you kidding me? So easy. å„ä½å¤§ä½¬ä»¬ç¨å®‰å‹¿èºï¼Œé˜…è¯»å¤§å‹æºç ä¸æ˜¯ä¸ªå®¹æ˜“çš„æ´»ï¼Œè®©æˆ‘ä»¬ä»æœ€ç®€å•çš„å¼€å§‹ï¼Œä¸€ç‚¹ä¸€ç‚¹å»ºç«‹è‡ªä¿¡ï¼Œå°†è¿™é¡¹ä¼Ÿå¤§çš„äº‹ä¸šè¿›è¡Œä¸‹å»ã€‚</p>

<p>é¢å¯¹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘çš„ç¬¬ä¸€ååº”æ˜¯å»æŸ¥ <code class="language-plaintext highlighter-rouge">Toast.LENGTH_LONG</code> å’Œ <code class="language-plaintext highlighter-rouge">Toast.LENGTH_SHORT</code> çš„å€¼ï¼Œæ¯•ç«Ÿå¹³æ—¶éƒ½æ˜¯ç”¨è¿™ä¸¤ä¸ªå€¼æ¥æ§åˆ¶æ˜¾ç¤ºé•¿/çŸ­ Toast çš„ã€‚</p>

<p>æ–‡ä»¶ <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/widget/Toast.java">platform_frameworks_base/core/java/android/widget/Toast.java</a> ä¸­èƒ½çœ‹åˆ°å®ƒä»¬ä¿©çš„å®šä¹‰æ˜¯è¿™æ ·çš„ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Show the view or text notification for a short period of time.  This time
 * could be user-definable.  This is the default.
 * @see #setDuration
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">LENGTH_SHORT</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

<span class="cm">/**
 * Show the view or text notification for a long period of time.  This time
 * could be user-definable.
 * @see #setDuration
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">LENGTH_LONG</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
</code></pre></div></div>

<p>å•Šå“¦~åŸæ¥å®ƒä»¬åªæ˜¯ä¸¤ä¸ª flagï¼Œå¹¶éç¡®åˆ‡çš„æ—¶é—´å€¼ã€‚</p>

<p>æ—¢ç„¶æ˜¯ flagï¼Œé‚£è‡ªç„¶å°±ä¼šæœ‰æ ¹æ®ä¸åŒçš„ flag æ¥è®¾ç½®ä¸åŒçš„å…·ä½“å€¼çš„åœ°æ–¹ï¼Œäºæ˜¯ä½¿ç”¨ insight.io ç‚¹å‡» <code class="language-plaintext highlighter-rouge">LENGTH_SHORT</code> çš„å®šä¹‰æœç´¢ä¸€æ³¢ <code class="language-plaintext highlighter-rouge">Toast.LENGTH_SHORT</code> çš„å¼•ç”¨ï¼Œåœ¨ <a href="https://github.com/aosp-mirror/platform_frameworks_base">aosp-mirror/platform_frameworks_base</a> é‡Œä¸€å…±æœ‰ 50 å¤„å¼•ç”¨ï¼Œä½†éƒ½æ˜¯è°ƒç”¨ <code class="language-plaintext highlighter-rouge">Toast.makeText(...)</code> æ—¶å‡ºç°çš„ã€‚</p>

<p>ç»§ç»­æœç´¢ <code class="language-plaintext highlighter-rouge">Toast.LENGTH_LONG</code> çš„å¼•ç”¨ï¼Œåœ¨ <a href="https://github.com/aosp-mirror/platform_frameworks_base">aosp-mirror/platform_frameworks_base</a> ä¸­å…±å‡ºç° 42 æ¬¡ï¼Œå…¶ä¸­æœ‰ä¸¤å¤„é•¿å¾—åƒæ˜¯æˆ‘ä»¬æƒ³æ‰¾çš„ï¼š</p>

<p>ç¬¬ä¸€å¤„ï¼Œæ–‡ä»¶ <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/widget/Toast.java">platform_frameworks_base/core/java/android/widget/Toast.java</a></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TN</span> <span class="kd">extends</span> <span class="nc">ITransientNotification</span><span class="o">.</span><span class="na">Stub</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">SHORT_DURATION_TIMEOUT</span> <span class="o">=</span> <span class="mi">4000</span><span class="o">;</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">LONG_DURATION_TIMEOUT</span> <span class="o">=</span> <span class="mi">7000</span><span class="o">;</span> 
    <span class="o">...</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleShow</span><span class="o">(</span><span class="nc">IBinder</span> <span class="n">windowToken</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="n">mParams</span><span class="o">.</span><span class="na">hideTimeoutMilliseconds</span> <span class="o">=</span> <span class="n">mDuration</span> <span class="o">==</span>
            <span class="nc">Toast</span><span class="o">.</span><span class="na">LENGTH_LONG</span> <span class="o">?</span> <span class="no">LONG_DURATION_TIMEOUT</span> <span class="o">:</span> <span class="no">SHORT_DURATION_TIMEOUT</span><span class="o">;</span>
        <span class="o">...</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿™ä¸ª hideTimeoutMilliseconds æ˜¯å¹²å˜›çš„å‘¢ï¼Ÿ</p>

<p>æ–‡ä»¶ <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/view/WindowManager.java">platform_frameworks_base/core/java/android/view/WindowManager.java</a> é‡Œèƒ½çœ‹åˆ°è¿™ä¸ª</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * ...
 * ...                                        . Therefore, we do hide
 * such windows to prevent them from overlaying other apps.
 *
 * @hide
 */</span>
<span class="kd">public</span> <span class="kt">long</span> <span class="n">hideTimeoutMilliseconds</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
</code></pre></div></div>

<p>åœ¨ GitHub ç”¨ blame æŸ¥çœ‹åˆ°æ”¹åŠ¨è¿™ä¸€è¡Œçš„æœ€è¿‘ä¸€æ¬¡æäº¤ <a href="https://github.com/aosp-mirror/platform_frameworks_base/commit/aa07653d2eea38a7a5bda5944c8a353586916ae9">aa07653d</a>ï¼Œå®ƒçš„ commit message èƒ½è¡¨æ˜å®ƒçš„ç”¨é€”ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Prevent apps to overlay other apps via toast windows

It was possible for apps to put toast type windows
that overlay other apps which toast winodws aren't
removed after a timeout.

Now for apps targeting SDK greater than N MR1 to add a
toast window one needs to have a special token. The token
is added by the notificatoion manager service only for
the lifetime of the shown toast and is then removed
including all windows associated with this token. This
prevents apps to add arbitrary toast windows.

Since legacy apps may rely on the ability to directly
add toasts we mitigate by allowing these apps to still
add such windows for unlimited duration if this app is
the currently focused one, i.e. the user interacts with
it then it can overlay itself, otherwise we make sure
these toast windows are removed after a timeout like
a toast would be.

We don't allow more that one toast window per UID being
added at a time which prevents 1) legacy apps to put the
same toast after a timeout to go around our new policy
of hiding toasts after a while; 2) modern apps to reuse
the passed token to add more than one window; Note that
the notification manager shows toasts one at a time.
</code></pre></div></div>

<p>å®ƒå¹¶ä¸æ˜¯ç”¨æ¥æ§åˆ¶ Toast çš„æ˜¾ç¤ºæ—¶é—´çš„ï¼Œåªæ˜¯ä¸ºäº†é˜²æ­¢æœ‰äº›åº”ç”¨çš„ toast ç±»å‹çš„çª—å£é•¿æœŸè¦†ç›–åœ¨åˆ«çš„åº”ç”¨ä¸Šé¢ï¼Œè€Œè¶…æ—¶è‡ªåŠ¨éšè—è¿™äº›çª—å£çš„æ—¶é—´ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§é˜²æŠ¤æªæ–½ã€‚</p>

<p>ç¬¬äºŒå¤„ï¼Œæ–‡ä»¶ <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/services/core/java/com/android/server/notification/NotificationManagerService.java">platform_frameworks_base/services/core/java/com/android/server/notification/NotificationManagerService.java</a> é‡Œ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">long</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">duration</span> <span class="o">==</span> <span class="nc">Toast</span><span class="o">.</span><span class="na">LENGTH_LONG</span> <span class="o">?</span> <span class="no">LONG_DELAY</span> <span class="o">:</span> <span class="no">SHORT_DELAY</span><span class="o">;</span>
</code></pre></div></div>

<p>åœ¨åŒä¸€æ–‡ä»¶é‡Œèƒ½æ‰¾åˆ° <code class="language-plaintext highlighter-rouge">LONG_DELAY</code> ä¸ <code class="language-plaintext highlighter-rouge">SHORT_DELAY</code> çš„å®šä¹‰ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">LONG_DELAY</span> <span class="o">=</span> <span class="nc">PhoneWindowManager</span><span class="o">.</span><span class="na">TOAST_WINDOW_TIMEOUT</span><span class="o">;</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">SHORT_DELAY</span> <span class="o">=</span> <span class="mi">2000</span><span class="o">;</span> <span class="c1">// 2 seconds</span>
</code></pre></div></div>

<p>ç‚¹å‡»æŸ¥çœ‹ <code class="language-plaintext highlighter-rouge">PhoneWindowManager.TOAST_WINDOW_TIMEOUT</code> çš„å®šä¹‰ï¼š</p>

<p>æ–‡ä»¶ <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/services/core/java/com/android/server/policy/PhoneWindowManager.java">platform_frameworks_base/services/core/java/com/android/server/policy/PhoneWindowManager.java</a></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/** Amount of time (in milliseconds) a toast window can be shown. */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">TOAST_WINDOW_TIMEOUT</span> <span class="o">=</span> <span class="mi">3500</span><span class="o">;</span> <span class="c1">// 3.5 seconds</span>
</code></pre></div></div>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡º <strong>ç»“è®ºï¼šToast çš„é•¿/çŸ­è¶…æ—¶æ—¶é—´åˆ†åˆ«ä¸º 3.5 ç§’å’Œ 2 ç§’ã€‚</strong></p>

<p><em>Tips: ä¹Ÿå¯ä»¥é€šè¿‡åˆ†æä»£ç é‡Œçš„é€»è¾‘ï¼Œä¸€å±‚ä¸€å±‚è¿½è¸ªç”¨åˆ° <code class="language-plaintext highlighter-rouge">LENGTH_SHORT</code> å’Œ <code class="language-plaintext highlighter-rouge">LENGTH_LONG</code> çš„åœ°æ–¹ï¼Œæœ€ç»ˆå¾—å‡ºç»“è®ºï¼Œè€Œè¿™é‡Œæ˜¯æ ¹æ®ä¸€äº›åˆç†æ¨æ–­æ¥ç®€åŒ–è¿½è¸ªè¿‡ç¨‹ï¼Œæ›´å¿«è¾¾åˆ°ç›®æ ‡ï¼Œè¿™åœ¨ä¸€äº›åœºæ™¯ä¸‹æ˜¯å¯å–å’Œå¿…è¦çš„ã€‚</em></p>

<h3 id="èƒ½ä¸èƒ½å¼¹ä¸€ä¸ªæ—¶é—´è¶…é•¿çš„-toast">èƒ½ä¸èƒ½å¼¹ä¸€ä¸ªæ—¶é—´è¶…é•¿çš„ Toastï¼Ÿ</h3>

<p>æ³¨ï¼šè¿™é‡Œæ¢è®¨çš„æ˜¯èƒ½å¦ç›´æ¥é€šè¿‡ Toast æä¾›çš„å…¬å¼€ API åšåˆ°ï¼Œç½‘ç»œä¸Šèƒ½æœç´¢åˆ°çš„ä½¿ç”¨ Timerã€åå°„ã€è‡ªå®šä¹‰ç­‰æ–¹å¼è¾¾åˆ°å¼¹å‡ºä¸€ä¸ªè¶…é•¿æ—¶é—´ Toast ç›®çš„çš„æ–¹æ³•ä¸åœ¨è®¨è®ºèŒƒå›´å†…ã€‚</p>

<p>æˆ‘ä»¬åœ¨ Toast ç±»çš„æºç é‡Œçœ‹ä¸€ä¸‹è·Ÿè®¾ç½®æ—¶é•¿ç›¸å…³çš„ä»£ç ï¼š</p>

<p>æ–‡ä»¶ <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/widget/Toast.java">platform_frameworks_base/core/java/android/widget/Toast.java</a></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">...</span>

    <span class="cm">/** @hide */</span>
    <span class="nd">@IntDef</span><span class="o">({</span><span class="no">LENGTH_SHORT</span><span class="o">,</span> <span class="no">LENGTH_LONG</span><span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">SOURCE</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">Duration</span> <span class="o">{}</span>

<span class="o">...</span>

    <span class="cm">/**
     * Set how long to show the view for.
     * @see #LENGTH_SHORT
     * @see #LENGTH_LONG
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDuration</span><span class="o">(</span><span class="nd">@Duration</span> <span class="kt">int</span> <span class="n">duration</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mDuration</span> <span class="o">=</span> <span class="n">duration</span><span class="o">;</span>
        <span class="n">mTN</span><span class="o">.</span><span class="na">mDuration</span> <span class="o">=</span> <span class="n">duration</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">...</span>

    <span class="cm">/**
     * Make a standard toast that just contains a text view.
     *
     * @param context  The context to use.  Usually your {@link android.app.Application}
     *                 or {@link android.app.Activity} object.
     * @param text     The text to show.  Can be formatted text.
     * @param duration How long to display the message.  Either {@link #LENGTH_SHORT} or
     *                 {@link #LENGTH_LONG}
     *
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Toast</span> <span class="nf">makeText</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nc">CharSequence</span> <span class="n">text</span><span class="o">,</span> <span class="nd">@Duration</span> <span class="kt">int</span> <span class="n">duration</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">makeText</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">text</span><span class="o">,</span> <span class="n">duration</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">...</span>
</code></pre></div></div>

<p>å…¶å®ä»ä¸Šé¢ <code class="language-plaintext highlighter-rouge">setDuration</code> å’Œ <code class="language-plaintext highlighter-rouge">makeText</code> çš„æ³¨é‡Šå·²ç»å¯ä»¥çœ‹å‡ºï¼Œduration åªèƒ½å–å€¼ <code class="language-plaintext highlighter-rouge">LENGTH_SHORT</code> å’Œ <code class="language-plaintext highlighter-rouge">LENGTH_LONG</code>ï¼Œé™¤äº†æ³¨é‡Šä¹‹å¤–ï¼Œè¿˜ä½¿ç”¨äº† <code class="language-plaintext highlighter-rouge">@Duration</code> æ³¨è§£æ¥ä¿è¯æ­¤äº‹ã€‚<code class="language-plaintext highlighter-rouge">Duration</code> è‡ªèº«ä½¿ç”¨äº† <code class="language-plaintext highlighter-rouge">@IntDef</code> æ³¨è§£ï¼Œå®ƒç”¨äºé™åˆ¶å¯ä»¥å–çš„å€¼ã€‚</p>

<p>æ–‡ä»¶ <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/annotation/IntDef.java">platform_frameworks_base/core/java/android/annotation/IntDef.java</a></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Denotes that the annotated element of integer type, represents
 * a logical type and that its value should be one of the explicitly
 * named constants. If the {@link #flag()} attribute is set to true,
 * multiple constants can be combined.
 * ...
 */</span>
</code></pre></div></div>

<p>ä¸ä¿¡é‚ªçš„æˆ‘ä»¬å¯ä»¥å¿«é€Ÿåœ¨ä¸€ä¸ª demo Android å·¥ç¨‹é‡Œå†™ä¸€å¥è¿™æ ·çš„ä»£ç è¯•è¯•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">"Hello"</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
</code></pre></div></div>

<p>Android Studio é¦–å…ˆå°±ä¸ä¼šåŒæ„ï¼Œè­¦å‘Šä½  <code class="language-plaintext highlighter-rouge">Must be one of: Toast.LENGTH_SHORT, Toast.LENGTH_LONG</code>ï¼Œä½†å®é™…è¿™æ®µä»£ç æ˜¯å¯ä»¥é€šè¿‡ç¼–è¯‘çš„ï¼Œå› ä¸º <code class="language-plaintext highlighter-rouge">Duration</code> æ³¨è§£çš„ <code class="language-plaintext highlighter-rouge">Retention</code> ä¸º <code class="language-plaintext highlighter-rouge">RetentionPolicy.SOURCE</code>ï¼Œæˆ‘çš„ç†è§£æ˜¯è¯¥æ³¨è§£ä¸»è¦èƒ½ç”¨äº IDE çš„æ™ºèƒ½æç¤ºè­¦å‘Šï¼Œç¼–è¯‘æœŸå°±è¢«ä¸¢æ‰äº†ã€‚</p>

<p>ä½†å³ä½¿ duration èƒ½ä¼ å…¥ <code class="language-plaintext highlighter-rouge">LENGTH_SHORT</code> å’Œ <code class="language-plaintext highlighter-rouge">LENGTH_LONG</code> ä»¥å¤–çš„å€¼ï¼Œä¹Ÿå¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ï¼Œåˆ«å¿˜äº†è¿™é‡Œè®¾ç½®çš„åªæ˜¯ä¸€ä¸ª flagï¼ŒçœŸæ­£è®¡ç®—çš„æ—¶å€™æ˜¯ <code class="language-plaintext highlighter-rouge">long delay = r.duration == Toast.LENGTH_LONG ? LONG_DELAY : SHORT_DELAY;</code>ï¼Œå³ duration ä¸º <code class="language-plaintext highlighter-rouge">LENGTH_LONG</code> æ—¶æ—¶é•¿ä¸º 3.5 ç§’ï¼Œå…¶å®ƒæƒ…å†µéƒ½æ˜¯ 2 ç§’ã€‚</p>

<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾—å‡º <strong>ç»“è®ºï¼šæ— æ³•é€šè¿‡ Toast æä¾›çš„å…¬å¼€ API ç›´æ¥å¼¹å‡ºè¶…é•¿æ—¶é—´çš„ Toastã€‚</strong>ï¼ˆå¦‚èŠ‚é¦–æ‰€è¿°ï¼Œå¯ä»¥é€šè¿‡ä¸€äº›å…¶å®ƒæ–¹å¼å®ç°ç±»ä¼¼çš„æ•ˆæœï¼‰</p>

<h3 id="toast-èƒ½ä¸èƒ½åœ¨é-ui-çº¿ç¨‹è°ƒç”¨">Toast èƒ½ä¸èƒ½åœ¨é UI çº¿ç¨‹è°ƒç”¨ï¼Ÿ</h3>

<p>è¿™ä¸ªé—®é¢˜é€‚åˆç”¨ä¸€ä¸ª demo æ¥è§£ç­”ã€‚</p>

<p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæœ€ç®€å•çš„ App å·¥ç¨‹ï¼Œç„¶ååœ¨å¯åŠ¨ Activity çš„ onCreate æ–¹æ³•é‡Œæ·»åŠ è¿™æ ·ä¸€æ®µä»£ç ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="nc">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="s">"Call toast on non-UI thread"</span><span class="o">,</span> <span class="nc">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">)</span>
                <span class="o">.</span><span class="na">show</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</code></pre></div></div>

<p>å•Šå“¦~å¾ˆé—æ†¾ç¨‹åºç›´æ¥æŒ‚æ‰äº†ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>11-07 13:35:33.980 2020-2035/org.mazhuang.androiduidemos E/AndroidRuntime: FATAL EXCEPTION: Thread-77
    java.lang.RuntimeException: Can't create handler inside thread that has not called Looper.prepare()
        at android.widget.Toast$TN.&lt;init&gt;(Toast.java:390)
        at android.widget.Toast.&lt;init&gt;(Toast.java:114)
        at android.widget.Toast.makeText(Toast.java:277)
        at android.widget.Toast.makeText(Toast.java:267)
        at org.mazhuang.androiduidemos.MainActivity$1.run(MainActivity.java:27)
        at java.lang.Thread.run(Thread.java:856)
</code></pre></div></div>

<p>é¡ºç€å †æ ˆé‡Œæ˜¾ç¤ºçš„æ–¹æ³•è°ƒç”¨ä»ä¸‹å¾€ä¸Šä¸€è·¯çœ‹è¿‡å»ï¼Œ</p>

<p>æ–‡ä»¶ <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/widget/Toast.java">platform_frameworks_base/core/java/android/widget/Toast.java</a></p>

<p>é¦–å…ˆæ˜¯ä¸¤çº§ makeText æ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æˆ‘ä»¬çš„ä»£ç é‡Œè°ƒç”¨çš„ makeText æ–¹æ³•</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">Toast</span> <span class="nf">makeText</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nc">CharSequence</span> <span class="n">text</span><span class="o">,</span> <span class="nd">@Duration</span> <span class="kt">int</span> <span class="n">duration</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">makeText</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">text</span><span class="o">,</span> <span class="n">duration</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// éšè—çš„ makeText æ–¹æ³•ï¼Œä¸èƒ½æ‰‹åŠ¨è°ƒç”¨</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">Toast</span> <span class="nf">makeText</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Looper</span> <span class="n">looper</span><span class="o">,</span>
        <span class="nd">@NonNull</span> <span class="nc">CharSequence</span> <span class="n">text</span><span class="o">,</span> <span class="nd">@Duration</span> <span class="kt">int</span> <span class="n">duration</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Toast</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Toast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">looper</span><span class="o">);</span> <span class="c1">// è¿™é‡Œçš„ looper ä¸º null</span>
    <span class="o">...</span>
</code></pre></div></div>

<p>ç„¶ååˆ°äº† Toast çš„æ„é€ æ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">Toast</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Looper</span> <span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
    <span class="n">mTN</span> <span class="o">=</span> <span class="k">new</span> <span class="no">TN</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getPackageName</span><span class="o">(),</span> <span class="n">looper</span><span class="o">);</span> <span class="c1">// looper ä¸º null</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>åˆ° Toast$TN çš„æ„é€ æ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// looper = null</span>
<span class="no">TN</span><span class="o">(</span><span class="nc">String</span> <span class="n">packageName</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Looper</span> <span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">looper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Use Looper.myLooper() if looper is not specified.</span>
        <span class="n">looper</span> <span class="o">=</span> <span class="nc">Looper</span><span class="o">.</span><span class="na">myLooper</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">looper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                    <span class="s">"Can't toast on a thread that has not called Looper.prepare()"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»è¿½è¸ªåˆ°äº†æˆ‘ä»¬çš„å´©æºƒçš„ RuntimeExceptionï¼Œå³è¦é¿å…è¿›å…¥æŠ›å‡ºå¼‚å¸¸çš„é€»è¾‘ï¼Œè¦ä¹ˆè°ƒç”¨çš„æ—¶å€™ä¼ é€’ä¸€ä¸ª Looper è¿›æ¥ï¼ˆæ— æ³•ç›´æ¥å®ç°ï¼Œèƒ½ä¼ é€’ Looper å‚æ•°çš„æ„é€ æ–¹æ³•ä¸ makeText æ–¹æ³•æ˜¯ hide çš„ï¼‰ï¼Œè¦ä¹ˆ <code class="language-plaintext highlighter-rouge">Looper.myLooper()</code> è¿”å›ä¸ä¸º nullï¼Œæç¤ºä¿¡æ¯ <code class="language-plaintext highlighter-rouge">Can't create handler inside thread that has not called Looper.prepare()</code> é‡Œç»™å‡ºäº†æ–¹æ³•ï¼Œé‚£æˆ‘ä»¬åœ¨ toast å‰é¢åŠ ä¸€å¥ <code class="language-plaintext highlighter-rouge">Looper.prepare()</code> è¯•è¯•ï¼Ÿè¿™æ¬¡ä¸å´©æºƒäº†ï¼Œä½†ä¾ç„¶ä¸å¼¹å‡º Toastï¼Œæ¯•ç«Ÿï¼Œè¿™ä¸ªçº¿ç¨‹åœ¨è°ƒç”¨å®Œ <code class="language-plaintext highlighter-rouge">show()</code> æ–¹æ³•åå°±ç›´æ¥ç»“æŸäº†ï¼Œæ²¡æœ‰è°ƒç”¨ <code class="language-plaintext highlighter-rouge">Looper.loop()</code>ï¼Œè‡³äºä¸ºä»€ä¹ˆè°ƒç”¨ Toast çš„çº¿ç¨‹ç»“æŸä¸å¦ä¼šå¯¹ Toast çš„æ˜¾ç¤ºéšè—ç­‰èµ·å½±å“ï¼Œåœ¨æœ¬æ–‡çš„åé¢çš„ç« èŠ‚é‡Œä¼šè¿›è¡Œåˆ†æã€‚</p>

<p>ä»å´©æºƒæç¤ºæ¥çœ‹ï¼ŒAndroid å¹¶æ²¡æœ‰é™åˆ¶åœ¨é UI çº¿ç¨‹é‡Œä½¿ç”¨ Toastï¼Œåªæ˜¯çº¿ç¨‹å¾—æ˜¯ä¸€ä¸ªæœ‰ Looper çš„çº¿ç¨‹ã€‚äºæ˜¯æˆ‘ä»¬å°è¯•æ„é€ å¦‚ä¸‹ä»£ç ï¼Œå‘ç°å¯ä»¥æˆåŠŸä»é UI çº¿ç¨‹å¼¹å‡º toast äº†ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="no">MSG_TOAST</span> <span class="o">=</span> <span class="mi">101</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="no">MSG_QUIT</span> <span class="o">=</span> <span class="mi">102</span><span class="o">;</span>

        <span class="nc">Looper</span><span class="o">.</span><span class="na">prepare</span><span class="o">();</span>

        <span class="kd">final</span> <span class="nc">Handler</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Handler</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>

                <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">case</span> <span class="nl">MSG_TOAST:</span>
                        <span class="nc">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="nc">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="s">"Call toast on non-UI thread"</span><span class="o">,</span> <span class="nc">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">show</span><span class="o">();</span>
                        <span class="n">sendEmptyMessageDelayed</span><span class="o">(</span><span class="no">MSG_QUIT</span><span class="o">,</span> <span class="mi">4000</span><span class="o">);</span>
                        <span class="k">return</span><span class="o">;</span>

                    <span class="k">case</span> <span class="nl">MSG_QUIT:</span>
                        <span class="nc">Looper</span><span class="o">.</span><span class="na">myLooper</span><span class="o">().</span><span class="na">quit</span><span class="o">();</span>
                        <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="kd">super</span><span class="o">.</span><span class="na">handleMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="n">handler</span><span class="o">.</span><span class="na">sendEmptyMessage</span><span class="o">(</span><span class="no">MSG_TOAST</span><span class="o">);</span>

        <span class="nc">Looper</span><span class="o">.</span><span class="na">loop</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</code></pre></div></div>

<p>è‡³äºä¸ºä»€ä¹ˆ <code class="language-plaintext highlighter-rouge">sendEmptyMesageDelayed(MSG_QUIT, 4000)</code> é‡Œçš„ delayMillis æˆ‘è®¾æˆäº† 4000ï¼Œè¿™é‡Œå–ä¸ªå…³å­ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥æŠŠè¿™ä¸ªå€¼è°ƒæˆ 0ã€1000 ç­‰ç­‰çœ‹ä¸€ä¸‹æ•ˆæœï¼Œä¼šæœ‰ä¸€äº›æ„æƒ³ä¸åˆ°çš„æƒ…å†µå‘ç”Ÿã€‚</p>

<p>åˆ°æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡º <strong>ç»“è®ºï¼šå¯ä»¥åœ¨é UI çº¿ç¨‹é‡Œè°ƒç”¨ Toastï¼Œä½†æ˜¯å¾—æ˜¯ä¸€ä¸ªæœ‰ Looper çš„çº¿ç¨‹ã€‚</strong></p>

<p>ps. ä¸Šé¢è¿™ä¸€æ®µæ¼”ç¤ºä»£ç è®©äººæ„Ÿè§‰ä¸ºäº†å¼¹å‡ºä¸€ä¸ª Toast å¥½éº»çƒ¦ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ Activity.runOnUiThreadã€View.post ç­‰æ–¹æ³•ä»é UI çº¿ç¨‹å°†é€»è¾‘åˆ‡æ¢åˆ° UI çº¿ç¨‹é‡Œæ‰§è¡Œï¼Œç›´æ¥ä» UI çº¿ç¨‹é‡Œå¼¹å‡ºï¼ŒUI çº¿ç¨‹æ˜¯æœ‰ Looper çš„ã€‚</p>

<p><em>çŸ¥è¯†ç‚¹ï¼šè¿™é‡Œå¦‚æœå¯¹ Looperã€Handler å’Œ MessageQueue æœ‰æ‰€äº†è§£ï¼Œå°±å®¹æ˜“ç†è§£å¤šäº†ï¼Œé¢„è®¡ä¸‹ä¸€ç¯‡å¯¹è¿™ä¸‰å‰‘å®¢è¿›è¡Œè®²è§£ã€‚</em></p>

<h3 id="åº”ç”¨åœ¨åå°æ—¶èƒ½ä¸èƒ½-toast">åº”ç”¨åœ¨åå°æ—¶èƒ½ä¸èƒ½ Toastï¼Ÿ</h3>

<p>è¿™ä¸ªé—®é¢˜ä¹Ÿæ¯”è¾ƒé€‚åˆç”¨ä¸€ä¸ªç®€å•çš„ demo æ¥å°è¯•å›ç­”ã€‚</p>

<p>åœ¨ MainActivity çš„ onCreate é‡ŒåŠ ä¸Šè¿™æ ·ä¸€æ®µä»£ç ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">view</span><span class="o">.</span><span class="na">postDelayed</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="nc">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="s">"background toast"</span><span class="o">,</span> <span class="nc">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">},</span> <span class="mi">5000</span><span class="o">);</span>
</code></pre></div></div>

<p>ç„¶åå¾…åº”ç”¨å¯åŠ¨åæŒ‰ HOME é”®ï¼Œç­‰å‡ ç§’çœ‹æ˜¯å¦èƒ½å¼¹å‡ºè¯¥ Toast å³å¯ã€‚</p>

<p><strong>ç»“è®ºæ˜¯ï¼šåº”ç”¨åœ¨åå°æ—¶å¯ä»¥å¼¹å‡º Toastã€‚</strong></p>

<h3 id="toast-æ•°é‡æœ‰æ²¡æœ‰é™åˆ¶">Toast æ•°é‡æœ‰æ²¡æœ‰é™åˆ¶ï¼Ÿ</h3>

<p>è¿™ä¸ªé—®é¢˜å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­ä¸€å¹¶è§£ç­”ã€‚</p>

<h3 id="toastmaketextshow-å…·ä½“éƒ½åšäº†äº›ä»€ä¹ˆ"><code class="language-plaintext highlighter-rouge">Toast.makeText(â€¦).show()</code> å…·ä½“éƒ½åšäº†äº›ä»€ä¹ˆï¼Ÿ</h3>

<p>é¦–å…ˆçœ‹ä¸€ä¸‹ makeText æ–¹æ³•ã€‚</p>

<p>æ–‡ä»¶ <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/widget/Toast.java">platform_frameworks_base/core/java/android/widget/Toast.java</a></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Make a standard toast to display using the specified looper.
 * If looper is null, Looper.myLooper() is used.
 * @hide
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">Toast</span> <span class="nf">makeText</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Looper</span> <span class="n">looper</span><span class="o">,</span>
        <span class="nd">@NonNull</span> <span class="nc">CharSequence</span> <span class="n">text</span><span class="o">,</span> <span class="nd">@Duration</span> <span class="kt">int</span> <span class="n">duration</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Toast</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Toast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">looper</span><span class="o">);</span>

    <span class="nc">LayoutInflater</span> <span class="n">inflate</span> <span class="o">=</span> <span class="o">(</span><span class="nc">LayoutInflater</span><span class="o">)</span>
            <span class="n">context</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="nc">Context</span><span class="o">.</span><span class="na">LAYOUT_INFLATER_SERVICE</span><span class="o">);</span>
    <span class="nc">View</span> <span class="n">v</span> <span class="o">=</span> <span class="n">inflate</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">transient_notification</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="nc">TextView</span> <span class="n">tv</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TextView</span><span class="o">)</span><span class="n">v</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">message</span><span class="o">);</span>
    <span class="n">tv</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>

    <span class="n">result</span><span class="o">.</span><span class="na">mNextView</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
    <span class="n">result</span><span class="o">.</span><span class="na">mDuration</span> <span class="o">=</span> <span class="n">duration</span><span class="o">;</span>

    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿™ä¸ªæ–¹æ³•é‡Œå°±æ˜¯æ„é€ äº†ä¸€ä¸ª Toast å¯¹è±¡ï¼Œå°†éœ€è¦å±•ç¤ºçš„ View å‡†å¤‡å¥½ï¼Œè®¾ç½®å¥½è¶…æ—¶æ—¶é•¿æ ‡è®°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ <code class="language-plaintext highlighter-rouge">com.android.internal.R.layout.transient_notification</code> è¿™ä¸ªå¸ƒå±€çš„å†…å®¹ï¼š</p>

<p>æ–‡ä»¶ <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/res/res/layout/transient_notification.xml">platform_frameworks_base/core/res/res/layout/transient_notification.xml</a></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span>
    <span class="na">android:layout_width=</span><span class="s">"match_parent"</span>
    <span class="na">android:layout_height=</span><span class="s">"match_parent"</span>
    <span class="na">android:orientation=</span><span class="s">"vertical"</span>
    <span class="na">android:background=</span><span class="s">"?android:attr/toastFrameBackground"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;TextView</span>
        <span class="na">android:id=</span><span class="s">"@android:id/message"</span>
        <span class="na">android:layout_width=</span><span class="s">"wrap_content"</span>
        <span class="na">android:layout_height=</span><span class="s">"wrap_content"</span>
        <span class="na">android:layout_weight=</span><span class="s">"1"</span>
        <span class="na">android:layout_marginHorizontal=</span><span class="s">"24dp"</span>
        <span class="na">android:layout_marginVertical=</span><span class="s">"15dp"</span>
        <span class="na">android:layout_gravity=</span><span class="s">"center_horizontal"</span>
        <span class="na">android:textAppearance=</span><span class="s">"@style/TextAppearance.Toast"</span>
        <span class="na">android:textColor=</span><span class="s">"@color/primary_text_default_material_light"</span>
        <span class="nt">/&gt;</span>

<span class="nt">&lt;/LinearLayout&gt;</span>
</code></pre></div></div>

<p>æˆ‘ä»¬æœ€å¸¸è§çš„ Toast å°±æ˜¯ä»è¿™ä¸ªå¸ƒå±€æ–‡ä»¶æ¸²æŸ“å‡ºæ¥çš„äº†ã€‚</p>

<p>æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹ makeText é‡Œè°ƒç”¨çš„ Toast çš„æ„é€ æ–¹æ³•é‡Œåšäº†å“ªäº›äº‹æƒ…ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Constructs an empty Toast object.  If looper is null, Looper.myLooper() is used.
 * @hide
 */</span>
<span class="kd">public</span> <span class="nf">Toast</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Looper</span> <span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
    <span class="n">mTN</span> <span class="o">=</span> <span class="k">new</span> <span class="no">TN</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getPackageName</span><span class="o">(),</span> <span class="n">looper</span><span class="o">);</span>
    <span class="n">mTN</span><span class="o">.</span><span class="na">mY</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">().</span><span class="na">getDimensionPixelSize</span><span class="o">(</span>
            <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">dimen</span><span class="o">.</span><span class="na">toast_y_offset</span><span class="o">);</span>
    <span class="n">mTN</span><span class="o">.</span><span class="na">mGravity</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">().</span><span class="na">getInteger</span><span class="o">(</span>
            <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">integer</span><span class="o">.</span><span class="na">config_toastDefaultGravity</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ä¸»è¦å°±æ˜¯æ„é€ äº†ä¸€ä¸ª TN å¯¹è±¡ï¼Œè®¡ç®—äº†ä½ç½®ã€‚</p>

<p>TN çš„æ„é€ æ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">TN</span><span class="o">(</span><span class="nc">String</span> <span class="n">packageName</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Looper</span> <span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// XXX This should be changed to use a Dialog, with a Theme.Toast</span>
    <span class="c1">// defined that sets up the layout params appropriately.</span>
    <span class="kd">final</span> <span class="nc">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">params</span> <span class="o">=</span> <span class="n">mParams</span><span class="o">;</span>
    <span class="n">params</span><span class="o">.</span><span class="na">height</span> <span class="o">=</span> <span class="nc">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">WRAP_CONTENT</span><span class="o">;</span>
    <span class="n">params</span><span class="o">.</span><span class="na">width</span> <span class="o">=</span> <span class="nc">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">WRAP_CONTENT</span><span class="o">;</span>
    <span class="n">params</span><span class="o">.</span><span class="na">format</span> <span class="o">=</span> <span class="nc">PixelFormat</span><span class="o">.</span><span class="na">TRANSLUCENT</span><span class="o">;</span>
    <span class="n">params</span><span class="o">.</span><span class="na">windowAnimations</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">style</span><span class="o">.</span><span class="na">Animation_Toast</span><span class="o">;</span>
    <span class="n">params</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="nc">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">TYPE_TOAST</span><span class="o">;</span>
    <span class="n">params</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="s">"Toast"</span><span class="o">);</span>
    <span class="n">params</span><span class="o">.</span><span class="na">flags</span> <span class="o">=</span> <span class="nc">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_KEEP_SCREEN_ON</span>
            <span class="o">|</span> <span class="nc">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_NOT_FOCUSABLE</span>
            <span class="o">|</span> <span class="nc">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_NOT_TOUCHABLE</span><span class="o">;</span>

    <span class="n">mPackageName</span> <span class="o">=</span> <span class="n">packageName</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">looper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Use Looper.myLooper() if looper is not specified.</span>
        <span class="n">looper</span> <span class="o">=</span> <span class="nc">Looper</span><span class="o">.</span><span class="na">myLooper</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">looper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                    <span class="s">"Can't toast on a thread that has not called Looper.prepare()"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">mHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Handler</span><span class="o">(</span><span class="n">looper</span><span class="o">,</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">};</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è®¾ç½®äº† LayoutParams çš„åˆå§‹å€¼ï¼Œåœ¨åé¢ show çš„æ—¶å€™ä¼šç”¨åˆ°ï¼Œè®¾ç½®äº†åŒ…åå’Œ Looperã€Handlerã€‚</p>

<p>TN æ˜¯ App ä¸­ç”¨äºä¸ Notification Service äº¤äº’çš„å¯¹è±¡ï¼Œè¿™é‡Œæ¶‰åŠåˆ° Binder å’Œè·¨è¿›ç¨‹é€šä¿¡çš„çŸ¥è¯†ï¼Œè¿™å—ä¼šåœ¨åé¢å¼€æ–°ç¯‡æ¥è®²è§£ï¼Œè¿™é‡Œå¯ä»¥ç®€å•åœ°ç†è§£ä¸€ä¸‹ï¼šNotification Service æ˜¯ç³»ç»Ÿä¸ºäº†ç®¡ç†å„ç§ App çš„ Notificationï¼ˆåŒ…æ‹¬ Toastï¼‰çš„æœåŠ¡ï¼Œæ¯”å¦‚ Toastï¼Œç”±è¿™ä¸ªæœåŠ¡æ¥ç»Ÿä¸€ç»´æŠ¤ä¸€ä¸ªå¾…å±•ç¤º Toast é˜Ÿåˆ—ï¼Œå„ App éœ€è¦å¼¹ Toast çš„æ—¶å€™å°±å°†ç›¸å…³ä¿¡æ¯å‘é€ç»™è¿™ä¸ªæœåŠ¡ï¼ŒæœåŠ¡ä¼šå°†å…¶åŠ å…¥é˜Ÿåˆ—ï¼Œç„¶åæ ¹æ®é˜Ÿåˆ—çš„æƒ…å†µï¼Œä¾æ¬¡é€šçŸ¥å„ App å±•ç¤ºå’Œéšè— Toastã€‚</p>

<p>æ¥ä¸‹æ¥çœ‹çœ‹ show æ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Show the view for the specified duration.
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">show</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mNextView</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"setView must have been called"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">INotificationManager</span> <span class="n">service</span> <span class="o">=</span> <span class="n">getService</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">pkg</span> <span class="o">=</span> <span class="n">mContext</span><span class="o">.</span><span class="na">getOpPackageName</span><span class="o">();</span>
    <span class="no">TN</span> <span class="n">tn</span> <span class="o">=</span> <span class="n">mTN</span><span class="o">;</span>
    <span class="n">tn</span><span class="o">.</span><span class="na">mNextView</span> <span class="o">=</span> <span class="n">mNextView</span><span class="o">;</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">service</span><span class="o">.</span><span class="na">enqueueToast</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">tn</span><span class="o">,</span> <span class="n">mDuration</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Empty</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è°ƒç”¨äº† INotificationManager çš„ enqueueToast æ–¹æ³•ï¼ŒINotificationManager æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶å®ç°ç±»åœ¨ NotificationManagerService é‡Œï¼Œæˆ‘ä»¬æ¥çœ‹ enqueueToast æ–¹æ³•çš„å®ç°ï¼š</p>

<p>æ–‡ä»¶ <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/services/core/java/com/android/server/notification/NotificationManagerService.java">platform_frameworks_base/services/core/java/com/android/server/notification/NotificationManagerService.java</a></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">enqueueToast</span><span class="o">(</span><span class="nc">String</span> <span class="n">pkg</span><span class="o">,</span> <span class="nc">ITransientNotification</span> <span class="n">callback</span><span class="o">,</span> <span class="kt">int</span> <span class="n">duration</span><span class="o">)</span>
<span class="o">{</span>
    <span class="o">...</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mToastQueue</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">ToastRecord</span> <span class="n">record</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">indexOfToastLocked</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">callback</span><span class="o">);</span>
            <span class="c1">// If it's already in the queue, we update it in place, we don't</span>
            <span class="c1">// move it to the end of the queue.</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
                <span class="n">record</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">duration</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// Limit the number of toasts that any given package except the android</span>
                <span class="c1">// package can enqueue.  Prevents DOS attacks and deals with leaks.</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">isSystemToast</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                    <span class="kd">final</span> <span class="kt">int</span> <span class="no">N</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="no">N</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                         <span class="kd">final</span> <span class="nc">ToastRecord</span> <span class="n">r</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                         <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">pkg</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">pkg</span><span class="o">))</span> <span class="o">{</span>
                             <span class="n">count</span><span class="o">++;</span>
                             <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="no">MAX_PACKAGE_NOTIFICATIONS</span><span class="o">)</span> <span class="o">{</span>
                                 <span class="nc">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Package has already posted "</span> <span class="o">+</span> <span class="n">count</span>
                                        <span class="o">+</span> <span class="s">" toasts. Not showing more. Package="</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">);</span>
                                 <span class="k">return</span><span class="o">;</span>
                             <span class="o">}</span>
                         <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>

                <span class="nc">Binder</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Binder</span><span class="o">();</span>
                <span class="n">mWindowManagerInternal</span><span class="o">.</span><span class="na">addWindowToken</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="no">TYPE_TOAST</span><span class="o">,</span> <span class="no">DEFAULT_DISPLAY</span><span class="o">);</span>
                <span class="n">record</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ToastRecord</span><span class="o">(</span><span class="n">callingPid</span><span class="o">,</span> <span class="n">pkg</span><span class="o">,</span> <span class="n">callback</span><span class="o">,</span> <span class="n">duration</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span>
                <span class="n">mToastQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">record</span><span class="o">);</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
                <span class="n">keepProcessAliveIfNeededLocked</span><span class="o">(</span><span class="n">callingPid</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// If it's at index 0, it's the current toast.  It doesn't matter if it's</span>
            <span class="c1">// new or just been updated.  Call back and tell it to show itself.</span>
            <span class="c1">// If the callback fails, this will remove it from the list, so don't</span>
            <span class="c1">// assume that it's valid after this.</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">showNextToastLocked</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="nc">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">callingId</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ä¸»è¦å°±æ˜¯ä½¿ç”¨è°ƒç”¨æ–¹ä¼ æ¥çš„åŒ…åã€callback å’Œ duration æ„é€ ä¸€ä¸ª ToastRecordï¼Œç„¶åæ·»åŠ åˆ° mToastQueue ä¸­ã€‚å¦‚æœåœ¨ mToastQueue ä¸­å·²ç»å­˜åœ¨è¯¥åŒ…åå’Œ callback çš„ Toastï¼Œåˆ™åªæ›´æ–°å…¶ durationã€‚</p>

<p>è¿™æ®µä»£ç é‡Œæœ‰ä¸€æ®µå¯ä»¥å›ç­”æˆ‘ä»¬çš„ä¸Šä¸€ä¸ªé—®é¢˜ <code class="language-plaintext highlighter-rouge">Toast æ•°é‡æœ‰æ²¡æœ‰é™åˆ¶</code> äº†ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Limit the number of toasts that any given package except the android</span>
<span class="c1">// package can enqueue.  Prevents DOS attacks and deals with leaks.</span>
<span class="k">if</span> <span class="o">(!</span><span class="n">isSystemToast</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="no">N</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="no">N</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
         <span class="kd">final</span> <span class="nc">ToastRecord</span> <span class="n">r</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">pkg</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">pkg</span><span class="o">))</span> <span class="o">{</span>
             <span class="n">count</span><span class="o">++;</span>
             <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="no">MAX_PACKAGE_NOTIFICATIONS</span><span class="o">)</span> <span class="o">{</span>
                 <span class="nc">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Package has already posted "</span> <span class="o">+</span> <span class="n">count</span>
                        <span class="o">+</span> <span class="s">" toasts. Not showing more. Package="</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">);</span>
                 <span class="k">return</span><span class="o">;</span>
             <span class="o">}</span>
         <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å³ä¼šè®¡ç®— mToastQueue é‡Œè¯¥åŒ…åçš„ Toast æ•°é‡ï¼Œå¦‚æœè¶…è¿‡ 50ï¼Œåˆ™å°†å½“å‰ç”³è¯·åŠ å…¥é˜Ÿåˆ—çš„ Toast æŠ›å¼ƒæ‰ã€‚æ‰€ä»¥ä¸Šä¸€ä¸ªé—®é¢˜çš„ <strong>ç»“è®ºæ˜¯ï¼šToast é˜Ÿåˆ—é‡Œå…è®¸æ¯ä¸ªåº”ç”¨å­˜åœ¨ä¸è¶…è¿‡ 50 ä¸ª Toastã€‚</strong></p>

<p>é‚£ä¹ˆæ„é€  ToastRecord å¹¶åŠ å…¥ mToastQueue ä¹‹åæ˜¯å¦‚ä½•è°ƒåº¦ï¼Œæ§åˆ¶æ˜¾ç¤ºå’Œéšè—çš„å‘¢ï¼ŸenqueueToast æ–¹æ³•é‡Œæœ‰ä¸ªé€»è¾‘æ˜¯å¦‚æœå½“å‰åˆ—è¡¨é‡Œåªæœ‰ä¸€ä¸ª ToastRecordï¼Œåˆ™è°ƒç”¨ <code class="language-plaintext highlighter-rouge">showNextToastLocked</code>ï¼Œçœ‹ä¸€ä¸‹ä¸è¯¥æ–¹æ³•ç›¸å…³çš„ä»£ç ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@GuardedBy</span><span class="o">(</span><span class="s">"mToastQueue"</span><span class="o">)</span>
<span class="kt">void</span> <span class="nf">showNextToastLocked</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ToastRecord</span> <span class="n">record</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">record</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">record</span><span class="o">.</span><span class="na">callback</span><span class="o">.</span><span class="na">show</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">token</span><span class="o">);</span>
            <span class="n">scheduleTimeoutLocked</span><span class="o">(</span><span class="n">record</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">...</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mToastQueue</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="o">...</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="nd">@GuardedBy</span><span class="o">(</span><span class="s">"mToastQueue"</span><span class="o">)</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">scheduleTimeoutLocked</span><span class="o">(</span><span class="nc">ToastRecord</span> <span class="n">r</span><span class="o">)</span>
<span class="o">{</span>
    <span class="n">mHandler</span><span class="o">.</span><span class="na">removeCallbacksAndMessages</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
    <span class="nc">Message</span> <span class="n">m</span> <span class="o">=</span> <span class="nc">Message</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="n">mHandler</span><span class="o">,</span> <span class="no">MESSAGE_TIMEOUT</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
    <span class="kt">long</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">duration</span> <span class="o">==</span> <span class="nc">Toast</span><span class="o">.</span><span class="na">LENGTH_LONG</span> <span class="o">?</span> <span class="no">LONG_DELAY</span> <span class="o">:</span> <span class="no">SHORT_DELAY</span><span class="o">;</span>
    <span class="n">mHandler</span><span class="o">.</span><span class="na">sendMessageDelayed</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">delay</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleTimeout</span><span class="o">(</span><span class="nc">ToastRecord</span> <span class="n">record</span><span class="o">)</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="no">DBG</span><span class="o">)</span> <span class="nc">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Timeout pkg="</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">pkg</span> <span class="o">+</span> <span class="s">" callback="</span> <span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">callback</span><span class="o">);</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mToastQueue</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">indexOfToastLocked</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">pkg</span><span class="o">,</span> <span class="n">record</span><span class="o">.</span><span class="na">callback</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">cancelToastLocked</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="nd">@GuardedBy</span><span class="o">(</span><span class="s">"mToastQueue"</span><span class="o">)</span>
<span class="kt">void</span> <span class="nf">cancelToastLocked</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ToastRecord</span> <span class="n">record</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">record</span><span class="o">.</span><span class="na">callback</span><span class="o">.</span><span class="na">hide</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="nc">ToastRecord</span> <span class="n">lastToast</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="n">mWindowManagerInternal</span><span class="o">.</span><span class="na">removeWindowToken</span><span class="o">(</span><span class="n">lastToast</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="no">DEFAULT_DISPLAY</span><span class="o">);</span>

    <span class="n">keepProcessAliveIfNeededLocked</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">pid</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mToastQueue</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Show the next one. If the callback fails, this will remove</span>
        <span class="c1">// it from the list, so don't assume that the list hasn't changed</span>
        <span class="c1">// after this point.</span>
        <span class="n">showNextToastLocked</span><span class="o">();</span> <span class="c1">// ç»§ç»­æ˜¾ç¤ºé˜Ÿåˆ—é‡Œçš„ä¸‹ä¸€ä¸ª Toast</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="o">...</span>

<span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">WorkerHandler</span> <span class="kd">extends</span> <span class="nc">Handler</span>
<span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="k">case</span> <span class="nl">MESSAGE_TIMEOUT:</span>
                <span class="n">handleTimeout</span><span class="o">((</span><span class="nc">ToastRecord</span><span class="o">)</span><span class="n">msg</span><span class="o">.</span><span class="na">obj</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">...</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å³é¦–å…ˆè°ƒç”¨ <code class="language-plaintext highlighter-rouge">record.callback.show(record.token)</code>ï¼Œé€šçŸ¥ App å±•ç¤ºè¯¥ Toastï¼Œç„¶åæ ¹æ® durationï¼Œå»¶æ—¶å‘é€ä¸€æ¡è¶…æ—¶æ¶ˆæ¯ <code class="language-plaintext highlighter-rouge">MESSAGE_TIMEOUT</code>ï¼ŒWorkHandler æ”¶åˆ°è¯¥æ¶ˆæ¯åï¼Œè°ƒç”¨ <code class="language-plaintext highlighter-rouge">cancelToastLocked</code> é€šçŸ¥åº”ç”¨éšè—è¯¥ Toastï¼Œå¹¶ç»§ç»­è°ƒç”¨ <code class="language-plaintext highlighter-rouge">showNextToastLocked</code> æ˜¾ç¤ºé˜Ÿåˆ—é‡Œçš„ä¸‹ä¸€ä¸ª Toastã€‚è¿™æ ·ä¸€ä¸ªæœºåˆ¶å°±ä¿è¯äº†åªè¦é˜Ÿåˆ—é‡Œæœ‰ ToastRecordï¼Œå°±èƒ½ä¾æ¬¡æ˜¾ç¤ºå‡ºæ¥ã€‚</p>

<p>æœºåˆ¶å¼„æ¸…æ¥šäº†ï¼Œå†è¯¦ç»†çœ‹ä¸€ä¸‹åº”ç”¨æ¥åˆ°é€šçŸ¥ show å’Œ hide ä¸€ä¸ª Toast åæ˜¯æ€ä¹ˆåšçš„ï¼š</p>

<p>æ–‡ä»¶ <a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/widget/Toast.java">platform_frameworks_base/core/java/android/widget/Toast.java</a></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TN</span> <span class="kd">extends</span> <span class="nc">ITransientNotification</span><span class="o">.</span><span class="na">Stub</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="no">TN</span><span class="o">(</span><span class="nc">String</span> <span class="n">packageName</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Looper</span> <span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="n">mHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Handler</span><span class="o">(</span><span class="n">looper</span><span class="o">,</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">case</span> <span class="nl">SHOW:</span> <span class="o">{</span>
                        <span class="nc">IBinder</span> <span class="n">token</span> <span class="o">=</span> <span class="o">(</span><span class="nc">IBinder</span><span class="o">)</span> <span class="n">msg</span><span class="o">.</span><span class="na">obj</span><span class="o">;</span>
                        <span class="n">handleShow</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">case</span> <span class="nl">HIDE:</span> <span class="o">{</span>
                        <span class="n">handleHide</span><span class="o">();</span>
                        <span class="o">...</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="o">...</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>

    <span class="cm">/**
     * schedule handleShow into the right thread
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">show</span><span class="o">(</span><span class="nc">IBinder</span> <span class="n">windowToken</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">localLOGV</span><span class="o">)</span> <span class="nc">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"SHOW: "</span> <span class="o">+</span> <span class="k">this</span><span class="o">);</span>
        <span class="n">mHandler</span><span class="o">.</span><span class="na">obtainMessage</span><span class="o">(</span><span class="no">SHOW</span><span class="o">,</span> <span class="n">windowToken</span><span class="o">).</span><span class="na">sendToTarget</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * schedule handleHide into the right thread
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hide</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">localLOGV</span><span class="o">)</span> <span class="nc">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"HIDE: "</span> <span class="o">+</span> <span class="k">this</span><span class="o">);</span>
        <span class="n">mHandler</span><span class="o">.</span><span class="na">obtainMessage</span><span class="o">(</span><span class="no">HIDE</span><span class="o">).</span><span class="na">sendToTarget</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="o">...</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleShow</span><span class="o">(</span><span class="nc">IBinder</span> <span class="n">windowToken</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
                <span class="n">mWM</span><span class="o">.</span><span class="na">addView</span><span class="o">(</span><span class="n">mView</span><span class="o">,</span> <span class="n">mParams</span><span class="o">);</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="o">...</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleHide</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">...</span>
                <span class="n">mWM</span><span class="o">.</span><span class="na">removeViewImmediate</span><span class="o">(</span><span class="n">mView</span><span class="o">);</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æ˜¾ç¤ºè¿‡ç¨‹ï¼šshow æ–¹æ³•è¢«è¿œç¨‹è°ƒç”¨åï¼Œå…ˆæ˜¯å‘é€äº†ä¸€ä¸ª SHOW æ¶ˆæ¯ï¼Œæ¥æ”¶åˆ°è¯¥æ¶ˆæ¯åè°ƒç”¨äº† handleShow æ–¹æ³•ï¼Œç„¶å <code class="language-plaintext highlighter-rouge">mWM.addView</code> å°†è¯¥ View æ·»åŠ åˆ°çª—å£ã€‚</p>

<p>éšè—è¿‡ç¨‹ï¼šhide æ–¹æ³•è¢«è¿œç¨‹è°ƒç”¨åï¼Œå…ˆæ˜¯å‘é€äº†ä¸€ä¸ª HIDE æ¶ˆæ¯ï¼Œæ¥æ”¶åˆ°è¯¥æ¶ˆæ¯åè°ƒç”¨äº† handleHide æ–¹æ³•ï¼Œç„¶å <code class="language-plaintext highlighter-rouge">mWM.removeViewImmediate</code> å°†è¯¥ View ä»çª—å£ç§»é™¤ã€‚</p>

<p><em>è¿™é‡Œæ’æ’­ä¸€æ¡ç»“è®ºï¼Œå°±æ˜¯å‰æ–‡ç•™ä¸‹çš„ä¸ºä»€ä¹ˆè°ƒç”¨ Toast çš„çº¿ç¨‹çº¿æŸä¹‹åæ²¡å¼¹å‡ºçš„ Toast å°±æ— æ³•å¼¹å‡ºäº†çš„é—®é¢˜ï¼Œå› ä¸º Notification Service é€šçŸ¥åº”ç”¨è¿›ç¨‹æ˜¾ç¤ºæˆ–éšè— Toast æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ <code class="language-plaintext highlighter-rouge">mHandler.obtainMessage(SHOW).sendToTarget()</code> ä¸ <code class="language-plaintext highlighter-rouge">mHandler.obtainMessage(HIDE).sendToTarget()</code>ï¼Œè¿™ä¸ªæ¶ˆæ¯å‘å‡ºå»åï¼ŒHandler å¯¹åº”çº¿ç¨‹æ²¡æœ‰åœ¨ <code class="language-plaintext highlighter-rouge">Looper.loop()</code> è¿‡ç¨‹é‡Œçš„è¯ï¼Œå°±æ²¡æœ‰åŠæ³•è¿›å…¥åˆ° Handler çš„ handleMessage æ–¹æ³•é‡Œå»ï¼Œè‡ªç„¶ä¹Ÿå°±æ— æ³•è°ƒç”¨æ˜¾ç¤ºå’Œéšè— View çš„æµç¨‹äº†ã€‚<code class="language-plaintext highlighter-rouge">Looper.loop()</code> ç›¸å…³çš„çŸ¥è¯†ç‚¹å°†åœ¨ä¸‹ç¯‡è®²è§£ã€‚</em></p>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<h3 id="è¡¥å……åçš„-toast-çŸ¥è¯†ç‚¹åˆ—è¡¨">è¡¥å……åçš„ Toast çŸ¥è¯†ç‚¹åˆ—è¡¨</h3>

<ol>
  <li>
    <p>Toast ä¸æ˜¯ Viewï¼Œå®ƒç”¨äºå¸®åŠ©åˆ›å»ºå¹¶å±•ç¤ºåŒ…å«ä¸€æ¡å°æ¶ˆæ¯çš„ Viewï¼›</p>
  </li>
  <li>
    <p>å®ƒçš„è®¾è®¡ç†å¿µæ˜¯å°½é‡ä¸æƒ¹çœ¼ï¼Œä½†åˆèƒ½å±•ç¤ºæƒ³è®©ç”¨æˆ·çœ‹åˆ°çš„ä¿¡æ¯ï¼›</p>
  </li>
  <li>
    <p>è¢«å±•ç¤ºæ—¶ï¼Œæµ®åœ¨åº”ç”¨ç•Œé¢ä¹‹ä¸Šï¼›</p>
  </li>
  <li>
    <p>æ°¸è¿œä¸ä¼šè·å–åˆ°ç„¦ç‚¹ï¼›</p>
  </li>
  <li>
    <p>å¤§å°å–å†³äºæ¶ˆæ¯çš„é•¿åº¦ï¼›</p>
  </li>
  <li>
    <p>è¶…æ—¶åä¼šè‡ªåŠ¨æ¶ˆå¤±ï¼›</p>
  </li>
  <li>
    <p>å¯ä»¥è‡ªå®šä¹‰æ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„ä½ç½®ï¼ˆé»˜è®¤å·¦å³å±…ä¸­æ˜¾ç¤ºåœ¨é è¿‘å±å¹•åº•éƒ¨çš„ä½ç½®ï¼‰ï¼›</p>
  </li>
  <li>
    <p>å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰å¸ƒå±€ï¼Œä¹Ÿåªæœ‰åœ¨è‡ªå®šä¹‰å¸ƒå±€çš„æ—¶å€™æ‰éœ€è¦ç›´æ¥è°ƒç”¨ Toast çš„æ„é€ æ–¹æ³•ï¼Œå…¶å®ƒæ—¶å€™éƒ½æ˜¯ä½¿ç”¨ makeText æ–¹æ³•æ¥åˆ›å»º Toastï¼›</p>
  </li>
  <li>
    <p>Toast å¼¹å‡ºåå½“å‰ Activity ä¼šä¿æŒå¯è§æ€§å’Œå¯äº¤äº’æ€§ï¼›</p>
  </li>
  <li>
    <p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">cancel</code> æ–¹æ³•å¯ä»¥ç«‹å³å°†å·²æ˜¾ç¤ºçš„ Toast å…³é—­ï¼Œè®©æœªæ˜¾ç¤ºçš„ Toast ä¸å†æ˜¾ç¤ºï¼›</p>
  </li>
  <li>
    <p>Toast ä¹Ÿç®—æ˜¯ä¸€ä¸ªã€Œé€šçŸ¥ã€ï¼Œå¦‚æœå¼¹å‡ºçŠ¶æ€æ¶ˆæ¯åæœŸæœ›å¾—åˆ°ç”¨æˆ·å“åº”ï¼Œåº”è¯¥ä½¿ç”¨ Notificationï¼›</p>
  </li>
  <li>
    <p>Toast çš„è¶…æ—¶æ—¶é—´ä¸º LENGTH_SHORT å¯¹åº” 2 ç§’ï¼ŒLENGTH_LONG å¯¹åº” 3.5 ç§’ï¼›</p>
  </li>
  <li>
    <p>ä¸èƒ½é€šè¿‡ Toast ç±»çš„å…¬å¼€æ–¹æ³•ç›´æ¥å¼¹ä¸€ä¸ªæ—¶é—´è¶…é•¿çš„ Toastï¼›</p>
  </li>
  <li>
    <p>åº”ç”¨åœ¨åå°æ—¶å¯ä»¥è°ƒç”¨ Toast å¹¶æ­£å¸¸å¼¹å‡ºï¼›</p>
  </li>
  <li>
    <p>Toast é˜Ÿåˆ—é‡Œå…è®¸å•ä¸ªåº”ç”¨å¾€é‡Œæ·»åŠ  50 ä¸ª Toastï¼Œè¶…å‡ºçš„å°†è¢«ä¸¢å¼ƒã€‚</p>
  </li>
</ol>

<h3 id="é—ç•™çŸ¥è¯†ç‚¹">é—ç•™çŸ¥è¯†ç‚¹</h3>

<p>æœ¬ç¯‡æ¶‰åŠåˆ°äº†ä¸€äº›éœ€è¦è¿›ä¸€æ­¥äº†è§£çš„çŸ¥è¯†ç‚¹ï¼Œåœ¨åç»­çš„ç¯‡ç« ä¸­ä¼šä¾æ¬¡è§£è¯»ï¼š</p>

<ol>
  <li>
    <p>Handlerã€Looper å’Œ MessageQueue</p>
  </li>
  <li>
    <p>WindowManager</p>
  </li>
  <li>
    <p>Binder ä¸è·¨è¿›ç¨‹é€šä¿¡</p>
  </li>
</ol>

<h3 id="æœ¬ç¯‡ç”¨åˆ°çš„æºç åˆ†ææ–¹æ³•">æœ¬ç¯‡ç”¨åˆ°çš„æºç åˆ†ææ–¹æ³•</h3>

<ol>
  <li>
    <p>æŸ¥æ‰¾å…³é”®å˜é‡è¢«å¼•ç”¨çš„åœ°æ–¹ï¼›</p>
  </li>
  <li>
    <p>æŒ‰æ–¹æ³•è°ƒç”¨å †æ ˆä¸€å±‚å±‚é€»è¾‘è·Ÿè¸ªä¸åˆ†æï¼›</p>
  </li>
  <li>
    <p>ä½¿ç”¨ git blame æŸ¥çœ‹å…³é”®ä»£ç è¡Œçš„å˜æ›´æ—¥å¿—ï¼›</p>
  </li>
</ol>

<h2 id="åè¯">åè¯</h2>

<p>åˆ°æ­¤ï¼Œä¸Šé¢æåˆ°çš„å‡ ä¸ªé—®é¢˜éƒ½å·²ç»è§£ç­”å®Œæ¯•ï¼Œå¯¹ Toast æºç çš„åˆ†æä¹Ÿå‘Šä¸€æ®µè½ã€‚</p>

<p>å†™è¿™ç¯‡æ–‡ç« èŠ±è´¹çš„æ—¶é—´æ¯”è¾ƒé•¿ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½æŒ‰ç…§é¢„è®¡çš„èŠ‚å¥æ›´æ–°ï¼Œè¿™é‡Œè¡¨ç¤ºæŠ±æ­‰ã€‚å¦å¤–ï¼Œå„ä½å¦‚æœæœ‰è€å¿ƒè¯»åˆ°è¿™é‡Œï¼Œè§‰å¾—æœ¬æ–‡çš„æ€è·¯æ˜¯å¦æ¸…æ™°ï¼Œæ˜¯å¦èƒ½è·Ÿéšæ–‡ç« çš„èŠ‚å¥ç†è§£ä¸€äº›ä¸œè¥¿ï¼Ÿå› ä¸ºæˆ‘ä¹Ÿåœ¨æ‘¸ç´¢å†™è¿™ç±»æ–‡ç« çš„ç»„ç»‡å½¢å¼ï¼Œæ‰€ä»¥ä¹Ÿå¸Œæœ›èƒ½æ”¶åˆ°åé¦ˆå’Œå»ºè®®ï¼Œä»¥ä½œæ”¹è¿›ï¼Œå…ˆè¡Œè°¢è¿‡ã€‚</p>

<hr />

<p>æœ€åï¼Œç…§ä¾‹è¦å®‰åˆ©ä¸€ä¸‹æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ã€Œé—·éªšçš„ç¨‹åºå‘˜ã€ï¼Œæ‰«ç å…³æ³¨ï¼Œæ¥æ”¶ rtfsc-android çš„æœ€è¿‘æ›´æ–°ã€‚</p>

<div align="center"><img width="192px" height="192px" src="https://mazhuang.org/assets/images/qrcode.jpg" /></div>

:ET