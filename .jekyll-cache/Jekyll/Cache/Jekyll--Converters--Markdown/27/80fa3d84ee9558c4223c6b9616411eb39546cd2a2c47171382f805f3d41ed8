I"âÀ<p>æœ¬æ–‡çš„è®¨è®ºå›´ç»•ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">java.lang.SecurityException</code> å±•å¼€ï¼Œå¼‚å¸¸çš„å…³é”®è¯æ˜¯æƒé™ <code class="language-plaintext highlighter-rouge">android.permission.INTERACT_ACROSS_USERS_FULL</code>ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">SecurityException</span><span class="o">:</span> <span class="nc">Permission</span> <span class="nl">Denial:</span> <span class="n">startActivity</span> <span class="n">asks</span> <span class="n">to</span> <span class="n">run</span> <span class="n">as</span> <span class="n">user</span> <span class="o">-</span><span class="mi">2</span> <span class="n">but</span> <span class="n">is</span> <span class="n">calling</span> <span class="n">from</span> <span class="n">user</span> <span class="mi">0</span><span class="o">;</span> <span class="k">this</span> <span class="n">requires</span> <span class="n">android</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">INTERACT_ACROSS_USERS_FULL</span>
    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span><span class="o">.</span><span class="na">readException</span><span class="o">(</span><span class="nc">Parcel</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1425</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcel</span><span class="o">.</span><span class="na">readException</span><span class="o">(</span><span class="nc">Parcel</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1379</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">ActivityManagerProxy</span><span class="o">.</span><span class="na">startActivityAsUser</span><span class="o">(</span><span class="nc">ActivityManagerNative</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1921</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">commands</span><span class="o">.</span><span class="na">am</span><span class="o">.</span><span class="na">Am</span><span class="o">.</span><span class="na">runStart</span><span class="o">(</span><span class="nc">Am</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">494</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">commands</span><span class="o">.</span><span class="na">am</span><span class="o">.</span><span class="na">Am</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">Am</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">109</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">commands</span><span class="o">.</span><span class="na">am</span><span class="o">.</span><span class="na">Am</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="nc">Am</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">82</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">RuntimeInit</span><span class="o">.</span><span class="na">nativeFinishInit</span><span class="o">(</span><span class="nc">Native</span> <span class="nc">Method</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">RuntimeInit</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="nc">RuntimeInit</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">235</span><span class="o">)</span>
</code></pre></div></div>

<p>å…ˆå°±æˆ‘æ‰€äº†è§£çš„çŸ¥è¯†è¯´ä¸€ä¸‹æ­¤å¼‚å¸¸å‘ç”Ÿçš„èƒŒæ™¯ã€‚</p>

<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>

<h3 id="android-ç³»ç»Ÿé‡Œçš„å¤šç”¨æˆ·">Android ç³»ç»Ÿé‡Œçš„å¤šç”¨æˆ·</h3>

<p>Android ç³»ç»Ÿæ˜¯åŸºäº Linux å†…æ ¸ï¼Œè€Œ Linux å†…æ ¸ä¸­ç”¨äºæ”¯æŒå¤šç”¨æˆ·æœºåˆ¶çš„ uid åœ¨ Android ä¸­è¢«ç”¨äºæ ‡è¯† app-specific sandboxã€‚<a href="http://developer.android.com/reference/android/os/Process.html#myUid()">android.os.Process ç±»çš„ myUid() æ–¹æ³•</a> çš„æè¿°é‡Œçš„åŸè¯æ˜¯ï¼š</p>

<blockquote>
  <p>Returns the identifier of this processâ€™s uid. This is the kernel uid that the process is running under, which is the identity of its app-specific sandbox. It is different from myUserHandle() in that a uid identifies a specific app sandbox in a specific user.</p>
</blockquote>

<p>æ‰€ä»¥æ³¨å®š Android å¦‚æœè¦å®ç°å¤šç”¨æˆ·ä¸èƒ½ç›´æ¥ä½¿ç”¨ Linux çš„ uid æœºåˆ¶äº†ï¼Œéœ€è¦å¦åšä¸€å¥—æœºåˆ¶ã€‚</p>

<p>åœ¨ Android API level 17 çš„ Features åˆ—è¡¨é‡Œæœ‰ä¸€é¡¹æ˜¯</p>

<blockquote>
  <p>Multiple user accounts (tablets only)</p>
</blockquote>

<p>æ‰€ä»¥åœ¨ API level 17 ä»¥ä¸Šçš„ Android ç³»ç»Ÿé‡Œå…¶å®å·²ç»å†…ç½®äº†å¤šç”¨æˆ·çš„æ”¯æŒï¼Œåªä¸è¿‡æš‚æ—¶åªå¯¹å¹³æ¿å¯ç”¨ï¼ˆæ®è¯´æ˜¯å› ä¸ºå¤šç”¨æˆ·æ‰‹æœºä¸“åˆ©æ—©å·²è¢« Symbian é›‡å‘˜æ³¨å†Œï¼Œä¸çŸ¥çœŸå‡ã€‚ï¼‰ã€‚åœ¨å®ç°ä¸Šæ˜¯æ–°å¼•å…¥äº† <a href="http://developer.android.com/reference/android/os/UserHandle.html">UserHandle</a> çš„æ¦‚å¿µï¼Œå°è£…äº† user idï¼Œåœ¨ <a href="http://developer.android.com/reference/android/os/Process.html#myUserHandle()">android.os.Process ç±»çš„ myUserHandle() æ–¹æ³•</a> çš„æè¿°é‡Œçš„åŸè¯æ˜¯ï¼š</p>

<blockquote>
  <p>Returns this processâ€™s user handle. This is the user the process is running under. It is distinct from myUid() in that a particular user will have multiple distinct apps running under it each with their own uid.</p>
</blockquote>

<h3 id="user-id-ä¸-uid">user id ä¸ uid</h3>

<p><strong>ç»“è®º</strong></p>

<ol>
  <li>user id = uid / 100000</li>
  <li>ç›®å‰ Android æ‰‹æœºä¸Šæ‰€æœ‰ APP çš„ user id éƒ½ä¸º 0</li>
  <li>root æƒé™ä¸ uid æ˜¯å¦ä¸º 0 æœ‰å…³ï¼Œä¸ user id æ— å…³</li>
</ol>

<p><strong>åˆ†æ</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Representation of a user on the device.
 */</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">UserHandle</span> <span class="kd">implements</span> <span class="nc">Parcelable</span> <span class="o">{</span>
    <span class="cm">/**
     * @hide Range of uids allocated for a user.
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">PER_USER_RANGE</span> <span class="o">=</span> <span class="mi">100000</span><span class="o">;</span>
    <span class="o">......</span>
    <span class="cm">/**
     * @hide Enable multi-user related side effects. Set this to false if
     * there are problems with single user use-cases.
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="no">MU_ENABLED</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">......</span>
    <span class="cm">/**
     * Returns the user id for a given uid.
     * @hide
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getUserId</span><span class="o">(</span><span class="kt">int</span> <span class="n">uid</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="no">MU_ENABLED</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">uid</span> <span class="o">/</span> <span class="no">PER_USER_RANGE</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="o">......</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿™ä¸ªç±»å®šä¹‰åœ¨ frameworks/base/core/java/android/os/UserHandle.java é‡Œã€‚</p>

<p>ä¸Šé¢è¿™æ®µä»£ç èƒ½å¾—å‡ºç»“è®º 1 é‡Œçš„å…¬å¼ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Tools for managing OS processes.
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Process</span> <span class="o">{</span>
    <span class="o">......</span>
    <span class="cm">/**
     * Defines the root UID.
     * @hide
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">ROOT_UID</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">......</span>
    <span class="cm">/**
     * Defines the start of a range of UIDs (and GIDs), going from this
     * number to {@link #LAST_APPLICATION_UID} that are reserved for assigning
     * to applications.
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">FIRST_APPLICATION_UID</span> <span class="o">=</span> <span class="mi">10000</span><span class="o">;</span>

    <span class="cm">/**
     * Last of application-specific UIDs starting at
     * {@link #FIRST_APPLICATION_UID}.
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">LAST_APPLICATION_UID</span> <span class="o">=</span> <span class="mi">19999</span><span class="o">;</span>
    <span class="o">......</span>        
<span class="o">}</span>
</code></pre></div></div>

<p>è¿™ä¸ªç±»å®šä¹‰åœ¨ frameworks/base/core/java/android/os/Process.java é‡Œã€‚</p>

<p>ä» <code class="language-plaintext highlighter-rouge">FIRST_APPLICATION_UID</code> ä¸ <code class="language-plaintext highlighter-rouge">LAST_APPLICATION_UID</code> çš„å€¼ï¼Œç»“åˆç»“è®º 1 é‡Œçš„å…¬å¼æ¥çœ‹ï¼Œæ‰€æœ‰ APP è¿è¡Œæ—¶è·å–è‡ªèº«çš„ user id éƒ½ä¸º 0ï¼›è€Œè¿è¡Œæ—¶ uid ä¸º <code class="language-plaintext highlighter-rouge">ROOT_UID</code> ï¼ˆå³ 0ï¼‰çš„ APP è·å–è‡ªèº«çš„ user id ä¹Ÿä¸º 0ï¼Œæ‰€ä»¥ user id æ˜¯å¦ä¸º 0 ä¸æ˜¯å¦è·å– root æƒé™å¹¶æ— å…³è”ã€‚</p>

<h3 id="å¼‚å¸¸å‘ç”Ÿçš„åœºæ™¯">å¼‚å¸¸å‘ç”Ÿçš„åœºæ™¯</h3>

<p>è¯¥å¼‚å¸¸å‘ç”Ÿåœ¨ API level 17 ä»¥ä¸Šçš„æœºå‹é‡Œï¼Œåœ¨ APP æˆ–è€… APP è°ƒç”¨çš„ Native è¿›ç¨‹é‡Œä½¿ç”¨ am start æ¥å¯åŠ¨ Activity æ—¶ã€‚</p>

<p>åœ¨ Java ä»£ç ä¸­ç›´æ¥ startActivity å¹¶ä¸ä¼šè§¦å‘æ­¤å¼‚å¸¸ã€‚</p>

<p>å¥½äº†ï¼ŒèƒŒæ™¯äº¤å¾…å®Œæ¯•ï¼Œä¸‹é¢æŒ‰æƒ¯ä¾‹å…ˆä¸Šç»“è®ºåŠè§£å†³æ–¹æ¡ˆï¼Œä»¥ä¾¿æ€¥äºè§£å†³æ–‡ç« å¼€å§‹æåˆ°çš„å¼‚å¸¸è€Œä¸æƒ³æ¢ç©¶åŸç†çš„åŒå­¦å¯ä»¥çœæ—¶åœ°å¸¦ç€ç»“è®ºå¿ƒæ»¡æ„è¶³åœ°ç¦»å»ã€‚</p>

<h2 id="ç»“è®ºåŠè§£å†³æ–¹æ¡ˆ">ç»“è®ºåŠè§£å†³æ–¹æ¡ˆ</h2>

<p>åœ¨ API level 17 ä»¥ä¸Šçš„ Android è®¾å¤‡é‡Œï¼Œé€šè¿‡ am start å‘½ä»¤æ¥å¯åŠ¨ Activity æ—¶ä¼šæ ¡éªŒè°ƒç”¨ am å‘½ä»¤çš„è¿›ç¨‹çš„ user id ä¸ am è¿›ç¨‹ä» â€“user å‚æ•°è·å–åˆ°çš„ user idï¼ˆé»˜è®¤å€¼ä¸º UserHandle.USER_CURRENTï¼Œå³ -2ï¼‰æ˜¯å¦ç›¸ç­‰ï¼Œ å¦‚æœæƒ³åœ¨ APP æˆ–è€… APP è°ƒç”¨çš„ Native è¿›ç¨‹é‡Œä½¿ç”¨ am start æ¥å¯åŠ¨ Activityï¼Œé‚£ä¹ˆéœ€è¦ç»™å…¶ä¼ é€’èƒ½é€šè¿‡æ ¡éªŒçš„ â€“user å‚æ•°ï¼Œå‚æ•°å€¼å¯ä»¥ç›´æ¥ç¡¬ç¼–ç ä¸º 0ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">android.os.Process.myUserHandle().hashCode()</code> çš„å€¼ã€‚</p>

<p>å¦‚æœä¸ç»™ am start ä¼ é€’æ­£ç¡®çš„ â€“user å‚æ•°ï¼Œé‚£è°ƒç”¨è¿›ç¨‹å¯¹åº” uid éœ€è¦æ‹¥æœ‰ INTERACT_ACROSS_USERS_FULL æƒé™ï¼Œä½†æ˜¯è¯¥æƒé™çš„ protectionLevel ä¸º <code class="language-plaintext highlighter-rouge">signature|installer</code>ï¼Œä¸€èˆ¬åœºæ™¯ä¸‹æ˜¯æ— æ³•è·å–åˆ°çš„ã€‚</p>

<p>æˆ‘åšäº†ä¸€ä¸ª Demo APPï¼Œé€šè¿‡ <code class="language-plaintext highlighter-rouge">Runtime.getRuntime().exec("am start xxxxxxx");</code> æ¥å¯åŠ¨æ‹”å·ç¨‹åºç•Œé¢ï¼Œæœ‰ä¸¤ä¸ªæŒ‰é’®åˆ†åˆ«æ¨¡æ‹Ÿäº†ä¼ é€’ä¸ä¸ä¼ é€’ â€“user å‚æ•°çš„æƒ…å†µï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹ç°è±¡ï¼Œå®Œæ•´æºç åœ¨ <a href="https://github.com/mzlogin/AndroidPractices/tree/master/android-studio/AuthorityDemo">AuthorityDemo</a>ã€‚</p>

<p>è¿è¡Œæˆªå›¾å¦‚ä¸‹ï¼š</p>

<p><img src="/images/posts/android/authority-demo.png" alt="authority demo" /></p>

<h2 id="åˆ†æ">åˆ†æ</h2>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†å€ŸåŠ©äºæºç å¯¹ am start çš„æ‰§è¡Œè¿‡ç¨‹è¿›è¡Œåˆ†æï¼Œä¸€ç‚¹ä¸€ç‚¹å¹æ•£è¿·é›¾ã€‚</p>

<h3 id="am-start-çš„æ‰§è¡Œè¿‡ç¨‹">am start çš„æ‰§è¡Œè¿‡ç¨‹</h3>

<p>am å‘½ä»¤çš„æºç åœ¨ frameworks/base/cmds/am é‡Œï¼Œé‡Œé¢çš„ am æ–‡ä»¶å³ä¸º am å‘½ä»¤ä¸»ä½“ï¼š</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/system/bin/sh</span>
<span class="c">#</span>
<span class="c"># Script to start "am" on the device, which has a very rudimentary</span>
<span class="c"># shell.</span>
<span class="c">#</span>
<span class="nv">base</span><span class="o">=</span>/system
<span class="nb">export </span><span class="nv">CLASSPATH</span><span class="o">=</span><span class="nv">$base</span>/framework/am.jar
<span class="nb">exec </span>app_process <span class="nv">$base</span>/bin com.android.commands.am.Am <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
</code></pre></div></div>

<p>è¿™æ®µä»£ç åœ¨ framworks/base/cmds/am/am é‡Œã€‚</p>

<p>am å‘½ä»¤æ˜¯é€šè¿‡ app_process æœ€ç»ˆè°ƒç”¨åˆ° com.android.commands.am.Am ç±»çš„ main æ–¹æ³•ï¼Œå¹¶å°†æ‰€æœ‰å‚æ•°ä¼ é€’ç»™ main æ¥æ‰§è¡Œåç»­æµç¨‹çš„ã€‚app_process ç›¸å…³çŸ¥è¯†ä¸ am start æ‰§è¡Œé€»è¾‘æ— å…³ï¼Œæ­¤å¤„ç•¥å»ä¸è¡¨ï¼Œæ”¾åœ¨æœ¬æ–‡æœ€åä¸€èŠ‚é™„å½•ä¸­è®²è§£ã€‚</p>

<p>am start çš„å…³é”®æ–¹æ³•è°ƒç”¨å¦‚ä¸‹ï¼š</p>

<p><img src="/images/posts/android/am-start-call-stack.svg" alt="am start call stack" /></p>

<p>æ–‡ç« å¼€å§‹å¤„çš„å¼‚å¸¸å°±æ˜¯åœ¨ handleIncomingUser æ–¹æ³•é‡Œæ ¡éªŒ user id å’Œæƒé™å¤±è´¥ä¹‹åæŠ›å‡ºçš„ã€‚ä¸‹é¢æŒ‰æ–¹æ³•è°ƒç”¨å±‚çº§è¯¦ç»†åˆ†æä¸€ä¸‹ï¼Œå¦‚ä¸‹æºç æ‰€åœ¨æºæ–‡ä»¶å¯ä»¥åœ¨ä¸Šå›¾ä¸­æ‰¾åˆ°ï¼š</p>

<h4 id="ammain">Am.main</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">(</span><span class="k">new</span> <span class="nc">Am</span><span class="o">()).</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å°±æ˜¯ä¸€ä¸ªç®€å•çš„ new å’Œ run æ–¹æ³•è°ƒç”¨ï¼Œè€Œ Am ç±»ä¸­å¹¶æ—  <code class="language-plaintext highlighter-rouge">run(String[])</code> åŸå‹çš„æ–¹æ³•ï¼Œæ‰€ä»¥å…¶å®è°ƒç”¨çš„æ˜¯ Am ç±»çš„åŸºç±» BaseCommand çš„ run æ–¹æ³•ã€‚</p>

<h4 id="basecommandrun">BaseCommand.run</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">......</span>
    <span class="n">mArgs</span> <span class="o">=</span> <span class="n">args</span><span class="o">;</span>
    <span class="o">......</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">onRun</span><span class="o">();</span>
        <span class="o">......</span>
    <span class="o">}</span>
    <span class="o">......</span>
<span class="o">}</span>
</code></pre></div></div>

<p>BaseCommand ç±»çš„ onRun æ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œæ‰€ä»¥å…¶å® run æ–¹æ³•åªæ˜¯ä¿å­˜äº†å‚æ•°ï¼Œç„¶åè°ƒç”¨äº† Am çš„ onRun æ–¹æ³•ã€‚</p>

<h4 id="amonrun">Am.onRun</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRun</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

    <span class="n">mAm</span> <span class="o">=</span> <span class="nc">ActivityManagerNative</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
    <span class="o">......</span>

    <span class="nc">String</span> <span class="n">op</span> <span class="o">=</span> <span class="n">nextArgRequired</span><span class="o">();</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">op</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"start"</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">runStart</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="o">......</span>
<span class="o">}</span>
</code></pre></div></div>

<p>onRun æ–¹æ³•ä¸»è¦æ˜¯å¯¹ am å‘½ä»¤åç¬¬ä¸€ä¸ªå‚æ•°è¿›è¡Œåˆ¤æ–­å¹¶è¿›è¡Œç›¸åº”çš„æ–¹æ³•è°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code class="language-plaintext highlighter-rouge">am start</code> æ˜¯è°ƒç”¨äº† runStart æ–¹æ³•ã€‚</p>

<p>è¿™é‡Œå¯ä»¥é¡ºä¾¿ç•™æ„åˆ°çš„æ˜¯ mAm å¯¹è±¡ï¼Œè¿½è¸ª <code class="language-plaintext highlighter-rouge">ActivityManagerNative.getDefault()</code> å¯ä»¥çŸ¥é“å®ƒæœ€ç»ˆé€šè¿‡ binder æœºåˆ¶å¯¹åº” ActivityManagerService å¯¹è±¡ã€‚</p>

<h4 id="amrunstart">Am.runStart</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Am</span> <span class="kd">extends</span> <span class="nc">BaseCommand</span> <span class="o">{</span>
    <span class="o">......</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">mWaitOption</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">......</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">mUserId</span><span class="o">;</span>
    <span class="o">......</span>
    <span class="kd">private</span> <span class="nc">Intent</span> <span class="nf">makeIntent</span><span class="o">(</span><span class="kt">int</span> <span class="n">defUser</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">URISyntaxException</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="n">mWaitOption</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">......</span>
        <span class="n">mUserId</span> <span class="o">=</span> <span class="n">defUser</span><span class="o">;</span>
        <span class="o">......</span>
        <span class="k">while</span> <span class="o">((</span><span class="n">opt</span><span class="o">=</span><span class="n">nextOption</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">opt</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"-a"</span><span class="o">))</span> <span class="o">{</span>
                <span class="o">......</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">opt</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"-W"</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">mWaitOption</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">......</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">opt</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"--user"</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">mUserId</span> <span class="o">=</span> <span class="n">parseUserArg</span><span class="o">(</span><span class="n">nextArgRequired</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="o">......</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">runStart</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="n">makeIntent</span><span class="o">(</span><span class="nc">UserHandle</span><span class="o">.</span><span class="na">USER_CURRENT</span><span class="o">);</span>
        <span class="o">......</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mWaitOption</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">mAm</span><span class="o">.</span><span class="na">startActivityAndWait</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="n">mimeType</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">mStartFlags</span><span class="o">,</span> <span class="n">profilerInfo</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">mUserId</span><span class="o">);</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">result</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">mAm</span><span class="o">.</span><span class="na">startActivityAsUser</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="n">mimeType</span><span class="o">,</span>
                    <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">mStartFlags</span><span class="o">,</span> <span class="n">profilerInfo</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">mUserId</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="o">......</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">res</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// å¯åŠ¨ Activity çš„ç»“æœæç¤º</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mWaitOption</span> <span class="o">&amp;&amp;</span> <span class="n">launched</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// è¾“å‡ºå¯åŠ¨ Activity çš„ç»“æœçŠ¶æ€ï¼Œèµ·æ­¢æ—¶é—´ç­‰</span>
        <span class="o">}</span>
        <span class="o">......</span>
    <span class="o">}</span>
    <span class="o">......</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ç”±å¦‚ä¸Šä»£ç å¯çŸ¥ï¼Œä¸€èˆ¬é€šè¿‡ am start å¯åŠ¨ Activity æ—¶è‹¥æœªä¼  -W å‚æ•°ï¼ˆæˆ‘ä¸€èˆ¬çš„åšæ³•ï¼‰ï¼Œä¼šè°ƒç”¨ ActivityManagerService.startActivityAsUser æ¥å¯åŠ¨ Activityã€‚ï¼ˆActivityManagerService.startActivityAndWait å…¶å®ä¸ ActivityManagerService.startActivityAsUser ç±»ä¼¼ï¼Œåªæ˜¯åœ¨å¯åŠ¨ Activity åå¤šäº†ä¸€ä¸ªç­‰å¾…è¿‡ç¨‹ï¼Œä¸‹é¢ä¸å†é‡å¤åˆ†æã€‚ï¼‰</p>

<p>è€Œ mUserId çš„å€¼ï¼Œè‹¥å‘½ä»¤è¡Œä¸­æœ‰ â€“user å‚æ•°ï¼Œåˆ™è¢«èµ‹ä¸ºè¯¥å‚æ•°çš„å€¼ï¼›è‹¥å‘½ä»¤è¡Œä¸­æ—  â€“user å‚æ•°ï¼Œåˆ™é»˜è®¤ä¸º <code class="language-plaintext highlighter-rouge">UserHandle.USER_CURRENT</code> çš„å€¼ï¼Œåœ¨ frameworks/base/core/java/android/os/UserHandle.java ä¸­å¯çŸ¥æ­¤é»˜è®¤å€¼ä¸º -2ã€‚</p>

<p>-2 è¿™ä¸ªæ•°å­—æ˜¯ä¸æ˜¯æœ‰ç‚¹ä¼¼æ›¾ç›¸ä¼¼ï¼Ÿæ²¡é”™ï¼Œæ–‡é¦–çš„å¼‚å¸¸ä¿¡æ¯é‡Œå°±æœ‰è¿™ä¸ªå€¼ã€‚</p>

<h4 id="activitymanagerservicestartactivityasuser">ActivityManagerService.startActivityAsUser</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">startActivityAsUser</span><span class="o">(</span><span class="nc">IApplicationThread</span> <span class="n">caller</span><span class="o">,</span> <span class="nc">String</span> <span class="n">callingPackage</span><span class="o">,</span>
        <span class="nc">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="nc">String</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">resultTo</span><span class="o">,</span> <span class="nc">String</span> <span class="n">resultWho</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span>
        <span class="kt">int</span> <span class="n">startFlags</span><span class="o">,</span> <span class="nc">ProfilerInfo</span> <span class="n">profilerInfo</span><span class="o">,</span> <span class="nc">Bundle</span> <span class="n">options</span><span class="o">,</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">enforceNotIsolatedCaller</span><span class="o">(</span><span class="s">"startActivity"</span><span class="o">);</span>
    <span class="n">userId</span> <span class="o">=</span> <span class="n">handleIncomingUser</span><span class="o">(</span><span class="nc">Binder</span><span class="o">.</span><span class="na">getCallingPid</span><span class="o">(),</span> <span class="nc">Binder</span><span class="o">.</span><span class="na">getCallingUid</span><span class="o">(),</span> <span class="n">userId</span><span class="o">,</span>
            <span class="kc">false</span><span class="o">,</span> <span class="no">ALLOW_FULL_ONLY</span><span class="o">,</span> <span class="s">"startActivity"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="c1">// TODO: Switch to user app stacks here.</span>
    <span class="k">return</span> <span class="n">mStackSupervisor</span><span class="o">.</span><span class="na">startActivityMayWait</span><span class="o">(</span><span class="n">caller</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">callingPackage</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span>
            <span class="n">resolvedType</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">resultTo</span><span class="o">,</span> <span class="n">resultWho</span><span class="o">,</span> <span class="n">requestCode</span><span class="o">,</span> <span class="n">startFlags</span><span class="o">,</span>
            <span class="n">profilerInfo</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">options</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Binder.getCallingUid()</code> æ˜¯ä¸€ä¸ª native æ–¹æ³•ï¼Œåœ¨ frameworks/base/core/java/android/os/Binder.java ä¸­èƒ½æ‰¾åˆ°ï¼Œå®ƒå…¶å®å°±æ˜¯è¿”å›äº†å½“å‰è¿›ç¨‹çš„ uidï¼Œè€Œ<strong>è¯¥ uid æ˜¯ä»çˆ¶è¿›ç¨‹ç»§æ‰¿çš„</strong>ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Return the Linux uid assigned to the process that sent you the
 * current transaction that is being processed.  This uid can be used with
 * higher-level system services to determine its identity and check
 * permissions.  If the current thread is not currently executing an
 * incoming transaction, then its own uid is returned.
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">getCallingUid</span><span class="o">();</span>
</code></pre></div></div>

<h4 id="activitymanagerservicehandleincominguser">ActivityManagerService.handleIncomingUser</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">handleIncomingUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">callingPid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">callingUid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">allowAll</span><span class="o">,</span>
        <span class="kt">int</span> <span class="n">allowMode</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">callerPackage</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">callingUserId</span> <span class="o">=</span> <span class="nc">UserHandle</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(</span><span class="n">callingUid</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">callingUserId</span> <span class="o">==</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userId</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="o">......</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">callingUid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">callingUid</span> <span class="o">!=</span> <span class="nc">Process</span><span class="o">.</span><span class="na">SYSTEM_UID</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">allow</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">checkComponentPermission</span><span class="o">(</span><span class="no">INTERACT_ACROSS_USERS_FULL</span><span class="o">,</span> <span class="n">callingPid</span><span class="o">,</span>
                <span class="n">callingUid</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span> <span class="o">==</span> <span class="nc">PackageManager</span><span class="o">.</span><span class="na">PERMISSION_GRANTED</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// If the caller has this permission, they always pass go.  And collect $200.</span>
            <span class="n">allow</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">allowMode</span> <span class="o">==</span> <span class="no">ALLOW_FULL_ONLY</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// We require full access, sucks to be you.</span>
            <span class="n">allow</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(......)</span> <span class="o">{</span>
            <span class="o">......</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">allow</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">userId</span> <span class="o">==</span> <span class="nc">UserHandle</span><span class="o">.</span><span class="na">USER_CURRENT_OR_SELF</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// In this case, they would like to just execute as their</span>
                <span class="c1">// owner user instead of failing.</span>
                <span class="n">targetUserId</span> <span class="o">=</span> <span class="n">callingUserId</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">StringBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">(</span><span class="mi">128</span><span class="o">);</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"Permission Denial: "</span><span class="o">);</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">callerPackage</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" from "</span><span class="o">);</span>
                    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">callerPackage</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" asks to run as user "</span><span class="o">);</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" but is calling from user "</span><span class="o">);</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="nc">UserHandle</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(</span><span class="n">callingUid</span><span class="o">));</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"; this requires "</span><span class="o">);</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">INTERACT_ACROSS_USERS_FULL</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">allowMode</span> <span class="o">!=</span> <span class="no">ALLOW_FULL_ONLY</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" or "</span><span class="o">);</span>
                    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="no">INTERACT_ACROSS_USERS</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
                <span class="nc">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">SecurityException</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="o">......</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å®ƒå…ˆæ ¡éªŒäº†å½“å‰è¿›ç¨‹çš„ user id ä¸å‚æ•°é‡Œçš„ userIdï¼ˆå³ â€“user çš„å€¼æˆ–é»˜è®¤çš„ -2ï¼‰æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰åˆ™æ­£å¸¸è¿”å›ï¼Œæ‰§è¡Œåç»­çš„å¯åŠ¨ Activity åŠ¨ä½œï¼›</p>

<p>å¦‚æœä¸ç›¸ç­‰ï¼Œæ™®é€šåº”ç”¨ç¨‹åºçš„ callingUid å¿…ä¸º 0ï¼Œåˆ™å…ˆè¿›è¡Œæƒé™æ ¡éªŒï¼Œçœ‹å½“å‰ pid å’Œ uid æ˜¯å¦è¢«èµ‹äºˆäº† INTERACT_ACROSS_USERS_FULL æƒé™ï¼Œæˆ‘ä»¬åœ¨å‰é¢çš„ã€Œç»“è®ºåŠè§£å†³æ–¹æ¡ˆã€ä¸€èŠ‚ä¸­å·²ç»äº¤å¾…è¿‡ï¼Œè¯¥æƒé™çš„ protectionLevel ä¸º <code class="language-plaintext highlighter-rouge">signature|installer</code>ï¼Œä¸€èˆ¬åœºæ™¯ä¸‹æ˜¯æ— æ³•è·å–åˆ°çš„ï¼›</p>

<p>å¦‚æœæ²¡æœ‰ INTERACT_ACROSS_USERS_FULL æƒé™ï¼ŒallowMode å‚æ•°å€¼åˆä¸º ALLOW_FULL_ONLY åˆ™å°†æŠ›å‡º SecurityExceptionï¼Œä»ä¸Šä¸€å°èŠ‚ã€ŒActivityManagerService.startActivityAsUserã€ä¸­è°ƒç”¨ handleIncomingUser çš„å‚æ•°å¯çŸ¥ allowMode å‚æ•°å°±æ˜¯ ALLOW_FULL_ONLYã€‚</p>

<p>ä¸Šæ–¹ä»£ç æ®µé‡Œçš„ <code class="language-plaintext highlighter-rouge">Permission Denial:</code>ã€<code class="language-plaintext highlighter-rouge">asks to run as user</code> å’Œ <code class="language-plaintext highlighter-rouge">but is calling from user</code> ç­‰å­—ç¬¦ä¸²æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Ÿè¿™å°±æ˜¯ä»æ–‡é¦–å¼€å§‹å›°æƒ‘æˆ‘ä»¬çš„å¼‚å¸¸æŠ›å‡ºçš„åœ°æ–¹ã€‚</p>

<p>è‡³æ­¤ï¼Œam start çš„å¤§æ¦‚æ‰§è¡Œè¿‡ç¨‹å’Œå¼‚å¸¸å‘ç”Ÿçš„æƒ…æ™¯åˆ†æå®Œæˆã€‚</p>

<h4 id="å®ç°åŠŸèƒ½é¿å…å¼‚å¸¸">å®ç°åŠŸèƒ½ï¼Œé¿å…å¼‚å¸¸</h4>

<p>ä»ä¸Šæ–¹çš„åˆ†æå¯çŸ¥ï¼Œè¦é¿å…å¼‚å¸¸æœ€ç›´æ¥æœ‰æ•ˆçš„æ–¹æ³•å°±æ˜¯è®© handleIncomingUser æ–¹æ³•æ­£å¸¸è¿”å›ï¼Œæ—¢ç„¶å£°æ˜ INTERACT_ACROSS_USERS_FULL æƒé™çš„è·¯ä¸é€šï¼Œå°±åªæœ‰ä¼ é€’ â€“user å‚æ•°äº†ã€‚</p>

<p>é‚£ä¹ˆç»™è¿™ä¸ªå‚æ•°ä¼ é€’ä»€ä¹ˆå€¼å‘¢ï¼Ÿ</p>

<p>ä»ä¸Šæ–‡çš„åˆ†æå¯çŸ¥ï¼Œè¯¥å‚æ•°åº”è¯¥ä¸ am è¿›ç¨‹çš„ user id ç›¸ç­‰ï¼Œæ‰€ä»¥ä¼ é€’çˆ¶è¿›ç¨‹çš„ user id å³å¯ã€‚ï¼ˆuser id ç”± uid è¿ç®—å¾—æ¥ï¼Œè€Œ uid ä¸çˆ¶è¿›ç¨‹ç›¸åŒã€‚ï¼‰</p>

<p>ç”±ã€ŒèƒŒæ™¯ã€ä¸€èŠ‚å¯çŸ¥ï¼Œæ‰€æœ‰ APP è¿›ç¨‹çš„ user id éƒ½ä¸º 0ï¼Œæ‰€ä»¥è¯¥å‚æ•°ç›´æ¥å†™ 0 æ˜¯å¯ä»¥çš„ï¼›å¦‚æœä¸æƒ³ç¡¬ç¼–ç ï¼Œé‚£ä¹ˆå¯ä»¥å…ˆç”¨ Process ç±»çš„ <code class="language-plaintext highlighter-rouge">myUserHandle()</code> æ–¹æ³•è·å–è¿›ç¨‹çš„ user handleï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Returns this process's user handle.  This is the
 * user the process is running under.  It is distinct from
 * {@link #myUid()} in that a particular user will have multiple
 * distinct apps running under it each with their own uid.
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">UserHandle</span> <span class="nf">myUserHandle</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">UserHandle</span><span class="o">(</span><span class="nc">UserHandle</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(</span><span class="n">myUid</span><span class="o">()));</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿™æ®µä»£ç å®šä¹‰åœ¨ frameworks/base/core/java/android/os/Process.java ä¸­ã€‚</p>

<p>ç»§ç»­åˆ†æ UserHandle ç±»é‡Œçš„ç›¸å…³æ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">UserHandle</span> <span class="kd">implements</span> <span class="nc">Parcelable</span> <span class="o">{</span>
    <span class="o">......</span>
    <span class="cm">/** @hide */</span>
    <span class="kd">public</span> <span class="nf">UserHandle</span><span class="o">(</span><span class="kt">int</span> <span class="n">h</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mHandle</span> <span class="o">=</span> <span class="n">h</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the userId stored in this UserHandle.
     * @hide
     */</span>
    <span class="nd">@SystemApi</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getIdentifier</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">mHandle</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="o">......</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">mHandle</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="o">......</span>
</code></pre></div></div>

<p>è¿™æ®µä»£ç å®šä¹‰åœ¨ frameworks/base/core/java/android/os/UserHandle.java ä¸­ã€‚</p>

<p>æ„é€ æ–¹æ³• <code class="language-plaintext highlighter-rouge">UserHandle(int h)</code> é‡Œå°† user id ä¿å­˜åœ¨ mHandle æˆå‘˜é‡Œï¼Œæœ¬æ¥ UserHandle ç±»æœ‰ä¸€ä¸ª getIdentifier æ–¹æ³•å¯ä»¥è¿”å› mHandle çš„ï¼Œä½†è¯¥æ–¹æ³•è¢«æ ‡ä¸ºäº† SystemApi å’Œ hideï¼Œæ— æ³•æ­£å¸¸è°ƒç”¨ï¼Œæ‰€ä»¥æ‰¾äº†ä¸€ä¸ªå–å·§çš„åŠæ³•ï¼Œä½¿ç”¨ä¹Ÿè¿”å› mHandle å€¼çš„ hashCode æ–¹æ³•æ¥è¾¾æˆç›®æ ‡ã€‚</p>

<p>æ‰€ä»¥ am start çš„ â€“user çš„å‚æ•°å¯ä»¥ç›´æ¥å†™ä¸º 0ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">android.os.Process.myUserHandle().hashCode()</code> çš„å€¼ã€‚</p>

<h2 id="å¼•ç”³æ€è€ƒ">å¼•ç”³æ€è€ƒ</h2>

<p>å¯åŠ¨ Activity çš„æ–¹æ³•å¹¶éåªæœ‰åœ¨ APP è¿›ç¨‹é‡Œä½¿ç”¨ am start ä¸€ç§ï¼Œè¿˜æœ‰é€šè¿‡ adb å‘½ä»¤ adb shell am start æˆ–åœ¨ APP è¿›ç¨‹é‡Œä½¿ç”¨ startActivity ç­‰ï¼Œå®ƒä»¬ä¸ºä»€ä¹ˆæ²¡æœ‰æŠ›å‡ºæ­¤å¼‚å¸¸å‘¢ï¼Ÿç»§ç»­æ¢ç´¢ã€‚</p>

<h3 id="ä¸ºä½•-adb-shell-am-start-ä¸æŠ›æ­¤å¼‚å¸¸">ä¸ºä½• adb shell am start ä¸æŠ›æ­¤å¼‚å¸¸</h3>

<p><strong>åŸå› ï¼š</strong> shell æ˜¯æ‹¥æœ‰ INTERACT_ACROSS_USERS_FULL æƒé™çš„ï¼Œæ‰€ä»¥ am start ä½œä¸ºå…¶å­è¿›ç¨‹ç»§æ‰¿äº† shell çš„ uid å’Œå¯¹åº”æƒé™ï¼Œåœ¨å¦‚ä¸Šæµç¨‹ä¸­ ActivityManagerService.handleIncomingUser é‡Œé€šè¿‡äº†æƒé™æ£€æŸ¥ï¼Œä¸ä¼šæŠ›å‡ºæ–‡é¦–çš„å¼‚å¸¸ã€‚</p>

<p>åœ¨ frameworks/base/packages/Shell/AndroidManifest.xml é‡Œæœ‰å¦‚ä¸‹å£°æ˜ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;manifest</span> <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span>
        <span class="na">package=</span><span class="s">"com.android.shell"</span>
        <span class="na">coreApp=</span><span class="s">"true"</span>
        <span class="na">android:sharedUserId=</span><span class="s">"android.uid.shell"</span>
        <span class="nt">&gt;</span>
    ......
    <span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.INTERACT_ACROSS_USERS_FULL"</span> <span class="nt">/&gt;</span>
    ......
<span class="nt">&lt;/manifest&gt;</span>    
</code></pre></div></div>

<h3 id="java-ä»£ç é‡Œ-startactivity-çš„æ‰§è¡Œè¿‡ç¨‹">Java ä»£ç é‡Œ startActivity çš„æ‰§è¡Œè¿‡ç¨‹</h3>

<p><img src="/images/posts/android/start-activity-call-stack.svg" alt="start activity call stack" /></p>

<p>å…¶å®ä¸ am start ä¸€æ ·ï¼Œéƒ½æ˜¯æ‰§è¡Œåˆ°äº† ActivityManagerService.startActivityAsUserï¼ŒåŒºåˆ«åœ¨äºå‚æ•°ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">startActivity</span><span class="o">(</span><span class="nc">IApplicationThread</span> <span class="n">caller</span><span class="o">,</span> <span class="nc">String</span> <span class="n">callingPackage</span><span class="o">,</span>
        <span class="nc">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="nc">String</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">resultTo</span><span class="o">,</span> <span class="nc">String</span> <span class="n">resultWho</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span>
        <span class="kt">int</span> <span class="n">startFlags</span><span class="o">,</span> <span class="nc">ProfilerInfo</span> <span class="n">profilerInfo</span><span class="o">,</span> <span class="nc">Bundle</span> <span class="n">options</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">startActivityAsUser</span><span class="o">(</span><span class="n">caller</span><span class="o">,</span> <span class="n">callingPackage</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="n">resultTo</span><span class="o">,</span>
        <span class="n">resultWho</span><span class="o">,</span> <span class="n">requestCode</span><span class="o">,</span> <span class="n">startFlags</span><span class="o">,</span> <span class="n">profilerInfo</span><span class="o">,</span> <span class="n">options</span><span class="o">,</span>
        <span class="nc">UserHandle</span><span class="o">.</span><span class="na">getCallingUserId</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>

<p>åœ¨ am start æµç¨‹ä¸­çš„ï¼Œä¼ ç»™ startActivityAsUser çš„æœ€åä¸€ä¸ªå‚æ•°æ˜¯ â€“user ä¼ å…¥çš„æˆ–è€…é»˜è®¤çš„ -2ï¼Œè€Œ Java ä»£ç é‡Œçš„ startActivity æµç¨‹ä¸­ä¼ ç»™ startActivityAsUser çš„æ˜¯ <code class="language-plaintext highlighter-rouge">UserHandle.getCallingUserId()</code>ï¼Œç›¸å½“äºåˆ° handleIncomingUser ä¸­æ˜¯å½“å‰è¿›ç¨‹çš„ user id ä¸å½“å‰è¿›ç¨‹çš„ user id æ¯”è¾ƒï¼ˆå¿…ç›¸ç­‰ï¼‰ï¼Œå¦‚æœç›¸ç­‰åˆ™é€šè¿‡æ ¡éªŒï¼Œæ‰€ä»¥å¿…èƒ½é€šè¿‡æ ¡éªŒï¼Œä¸ä¼šæŠ›å‡ºæ–‡é¦–è¯´çš„å¼‚å¸¸ã€‚</p>

<h2 id="é™„å½•">é™„å½•</h2>

<h3 id="app_process-ç®€è¦æ‰§è¡Œè¿‡ç¨‹">app_process ç®€è¦æ‰§è¡Œè¿‡ç¨‹</h3>

<p><img src="/images/posts/android/app-process.svg" alt="app process" /></p>

<p>åœ¨ç¬¬ 2 æ­¥ï¼ŒAndroidRuntime::start ä¸­è°ƒç”¨äº† <code class="language-plaintext highlighter-rouge">startVm</code> å¯åŠ¨è™šæ‹Ÿæœºï¼Œæœ€ç»ˆåœ¨ç¬¬ 5 æ­¥ AppRuntime::onStarted ä¸­è°ƒç”¨é€šè¿‡å‚æ•°ä¼ è¿›æ¥çš„ç±»çš„ main æ–¹æ³•ï¼Œå¹¶å°†ç±»ååçš„å‚æ•°ä¼ ç»™å®ƒã€‚</p>

:ET