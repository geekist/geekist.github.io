I"İ <h3 id="é—®é¢˜æè¿°">é—®é¢˜æè¿°</h3>

<p>åœ¨ Windows Vista+ ç³»ç»Ÿä¸‹ï¼Œè‹¥ EXE æ–‡ä»¶åä¸­åŒ…å«æœ‰ã€Œinstallã€ã€ã€Œupdateã€æˆ–ã€Œsetupã€ç­‰å­—æ ·ï¼Œå¯èƒ½å‡ºç°å¦‚ä¸‹é—®é¢˜ï¼š</p>

<ol>
  <li>
    <p>æ¯æ¬¡è½¯ä»¶è¿è¡Œå®Œé€€å‡ºåä¼šå¼¹å‡ºã€Œç¨‹åºå…¼å®¹æ€§åŠ©æ‰‹ã€ï¼ˆProgram Compatibility Assistant, ç®€ç§° PCAï¼‰ï¼Œæç¤ºè½¯ä»¶æœªæ­£ç¡®å®‰è£…ã€‚</p>

    <p><img src="/images/posts/windows/pca.png" alt="" /></p>
  </li>
  <li>
    <p>åœ¨ Vista+ çš„æ“ä½œç³»ç»Ÿä¸‹ä»»åŠ¡æ å³é”®è¯¥ç¨‹åºç¼ºå°‘ã€Œå°†æ­¤ç¨‹åºé”å®šåˆ°ä»»åŠ¡æ ã€å’Œè½¯ä»¶ååŒåé¡¹ã€‚</p>

    <table>
      <thead>
        <tr>
          <th>ç¨‹åºå</th>
          <th>è¿è¡Œæ—¶ä»»åŠ¡æ å³é”®</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>a.exe</td>
          <td><img src="/images/posts/windows/a.png" alt="" /></td>
        </tr>
        <tr>
          <td>setup.exe</td>
          <td><img src="/images/posts/windows/setup.png" alt="" /></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>ä½ çš„ç¨‹åºæ²¡æ‰“ç®—è¦æ±‚ç®¡ç†å‘˜æƒé™çš„ï¼Œä½†æ˜¯è¿è¡Œçš„æ—¶å€™å´å¼¹ UAC äº†ã€‚</p>

    <p>å®Œå…¨ç›¸åŒçš„ä¸¤ä¸ª EXE æ–‡ä»¶ï¼Œåå­—ä¸ä¸€æ ·ï¼š</p>

    <p><img src="/images/posts/windows/name.png" alt="" /></p>
  </li>
</ol>

<h3 id="é—®é¢˜åˆ†æ">é—®é¢˜åˆ†æ</h3>

<p>ç®€è€Œè¨€ä¹‹ï¼Œä¸Šè¿°ç°è±¡å‘ç”Ÿçš„åŸå› æ˜¯ Windows Vista+ ç³»ç»Ÿçš„ã€Œå®‰è£…ç¨‹åºæ£€æµ‹ã€æœºåˆ¶è®¤ä¸ºæ–‡ä»¶åä¸­åŒ…å«ã€Œinstallã€ã€ã€Œupdateã€æˆ–ã€Œsetupã€ç­‰å­—æ ·ï¼Œä¸”æ²¡æœ‰åœ¨ Manifest æ–‡ä»¶ä¸­æ˜¾å¼æŒ‡å®š requestedExecutionLevel çš„ 32 ä½å¯æ‰§è¡Œç¨‹åºæ˜¯å®‰è£…åŒ…ï¼Œä¼šä¸»åŠ¨ä¸ºå®‰è£…åŒ…å¼¹å‡º UAC ææƒç”³è¯·ï¼Œè€Œã€Œç¨‹åºå…¼å®¹æ€§åŠ©æ‰‹ã€ä¼šç›‘æ§å®‰è£…åŒ…çš„æ‰§è¡Œæƒ…å†µï¼Œå¦‚æœå®ƒæ²¡æœ‰åœ¨ã€Œæ·»åŠ æˆ–åˆ é™¤ç¨‹åºã€ä¸­åˆ›å»ºä¸€ä¸ªæ¡ç›®ï¼Œé‚£ã€Œç¨‹åºå…¼å®¹æ€§åŠ©æ‰‹ã€ä¼šè®¤ä¸ºè¯¥å®‰è£…åŒ…æ²¡æœ‰æˆåŠŸå®Œæˆï¼Œåœ¨å®‰è£…åŒ…ç»“æŸåå³å¼¹å‡ºã€Œç¨‹åºå…¼å®¹æ€§åŠ©æ‰‹ã€æç¤ºç”¨æˆ·è¯¥ç¨‹åºå¯èƒ½å®‰è£…ä¸æ­£ç¡®ã€‚</p>

<p>MSDN å…³äºã€Œç¨‹åºå…¼å®¹æ€§åŠ©æ‰‹ã€çš„ç›¸å…³é—®ç­”ï¼š</p>

<blockquote>
  <ol>
    <li>
      <p>What is the detection logic, and how does PCA know that the setup failed due to version problems?</p>

      <p>PCA does not specifically look for the setupâ€™s failing due to version problems. The logic used by PCA is to detect if a setup did not complete successfully. It monitors a program detected as setup by Windows Vista and Windows Server 2008 and checks whether the program registers an entry in Add or Remove Programs (ARP). If no entries are created in ARP, PCA concludes that the installer did not complete successfully. It will then wait for the install program to terminate before displaying the UI. If it is an uninstaller, the detection looks for whether an entry was deleted from ARP.</p>
    </li>
    <li>
      <p>How does PCA get information about the setup programs?</p>

      <p>PCA relies on the User Account Control (UAC) feature in Windows Vista and Windows Server 2008 to know whether a program is a setup program. UAC includes detection for setup programs and will make sure the detected setup programs will be run as Administrator, which includes getting administrative credentials or confirmation from the user before launching the program.</p>
    </li>
  </ol>
</blockquote>

<p>åŸæ–‡é“¾æ¥ï¼š<a href="https://msdn.microsoft.com/zh-cn/bb756937">Application Compatibility: Program Compatibility Assistant (PCA)</a></p>

<p>MSDN å…³äºã€Œå®‰è£…ç¨‹åºæ£€æµ‹ã€çš„ç›¸å…³ä»‹ç»ï¼š</p>

<blockquote>
  <p>Installer Detection only applies to:</p>

  <ul>
    <li>32 bit executables</li>
    <li>Applications without a requestedExecutionLevel</li>
    <li>Interactive processes running as a Standard User with UAC enabled</li>
  </ul>

  <p>Before a 32 bit process is created, the following attributes are checked to determine whether it is an installer:</p>

  <ul>
    <li>Filename includes keywords like â€œinstall,â€ â€œsetup,â€ â€œupdate,â€ etc.</li>
    <li>Keywords in the following Versioning Resource fields: Vendor, Company Name, Product Name, File Description, Original Filename, Internal Name, and Export Name</li>
    <li>Keywords in the side-by-side application manifest embedded in the executable</li>
    <li>Keywords in specific StringTable entries linked in the executable</li>
    <li>Key attributes in the resource file data linked in the executable</li>
    <li>Targeted sequences of bytes within the executable</li>
  </ul>
</blockquote>

<p>åŸæ–‡é“¾æ¥ï¼š<a href="https://msdn.microsoft.com/EN-US/library/bb756960(v=VS.10,d=hv.2).aspx">New UAC Technologies for Windows Vista</a></p>

<p>å¦å¤–ï¼Œå¾®è½¯çš„ä¸€ä¸ª PPT ä»‹ç»äº†ã€Œå®‰è£…ç¨‹åºæ£€æµ‹ã€å’Œå®ƒå¯èƒ½äº§ç”Ÿçš„è¯¯åˆ¤ï¼Œä»¥åŠè§£å†³çš„åŠæ³•ï¼Œç»™å‡ºçš„æ–¹æ¡ˆæ˜¯å†…åµŒ Manifest æˆ–è€…å¤–ç½®ä¸€ä¸ªåä¸ºã€ŒMyApp.exe.manifestã€çš„æ–‡ä»¶ï¼š</p>

<ul>
  <li><a href="https://www.google.com.hk/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=2&amp;ved=0CCUQFjABahUKEwiPmdW8rYjJAhVHG5QKHQwjBzY&amp;url=%68%74%74%70%3a%2f%2f%64%6f%77%6e%6c%6f%61%64%2e%6d%69%63%72%6f%73%6f%66%74%2e%63%6f%6d%2f%64%6f%77%6e%6c%6f%61%64%2f%38%2f%43%2f%44%2f%38%43%44%30%31%35%42%42%2d%30%38%31%42%2d%34%39%43%35%2d%41%35%30%36%2d%39%43%39%42%35%37%30%42%38%44%44%32%2f%49%6e%73%74%61%6c%6c%65%72%44%65%74%65%63%74%69%6f%6e%2e%70%70%74%78&amp;usg=AFQjCNHXcaCOv_FFndx0mxn7eovywzKQMg">Installer Detection - Microsoft</a></li>
</ul>

<p>å‚è€ƒï¼š</p>

<ul>
  <li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd371711(v=vs.85).aspx">Application Manifest</a></li>
  <li><a href="https://msdn.microsoft.com/zh-cn/enus/library/bb963893.aspx">Application Compatibility: UAC: Standard User Changes</a></li>
</ul>

<h3 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h3>

<p><strong>é—®é¢˜ 1ï¼š</strong></p>

<p>å¦‚ä¸‹ä¸‰é¡¹ä»»é€‰å…¶ä¸€ï¼š</p>

<p>ä¸€ã€ç»™ç¨‹åºæ”¹ä¸ªåå­—ï¼Œä¸è¦åŒ…å«ã€Œinstallã€ã€ã€Œupdateã€å’Œã€Œsetupã€å­—æ ·ã€‚</p>

<p>äºŒã€ä¸ºå¯æ‰§è¡Œæ–‡ä»¶æ·»åŠ ç±»ä¼¼å¦‚ä¸‹çš„ Manifest æ–‡ä»¶ï¼ŒæŒ‡å®šç¨‹åºå…¼å®¹ Win7 ä¸ Vistaï¼ˆæˆ–æ›´é«˜ç‰ˆæœ¬çš„å½“å‰ç³»ç»Ÿï¼‰ã€‚</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span>
  <span class="nt">&lt;assembly</span> <span class="na">xmlns=</span><span class="s">"urn:schemas-microsoft-com:asm.v1"</span> <span class="na">manifestVersion=</span><span class="s">"1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;compatibility</span> <span class="na">xmlns=</span><span class="s">"urn:schemas-microsoft-com:compatibility.v1"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;application&gt;</span>
        <span class="c">&lt;!--The ID below indicates application support for Windows Vista --&gt;</span>
          <span class="nt">&lt;supportedOS</span> <span class="na">Id=</span><span class="s">"{e2011457-1546-43c5-a5fe-008deee3d3f0}"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--The ID below indicates application support for Windows 7 --&gt;</span>
          <span class="nt">&lt;supportedOS</span> <span class="na">Id=</span><span class="s">"{35138b9a-5d96-4fbd-8e2d-a2440225f93a}"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/application&gt;</span>
    <span class="nt">&lt;/compatibility&gt;</span>
  <span class="nt">&lt;/assembly&gt;</span>
</code></pre></div></div>
<p>ä¸‰ã€ç¨‹åºè¿è¡Œæ—¶åœ¨æ³¨å†Œè¡¨é¡¹ <code class="language-plaintext highlighter-rouge">HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Compatibility Assistant\Persisted</code> ä¸‹å†™å…¥ä»¥å¯æ‰§è¡Œæ–‡ä»¶å…¨è·¯å¾„ä¸ºåï¼Œå€¼ä¸º REG_DWORD ç±»å‹çš„ 1 çš„é¡¹ã€‚</p>

<p><strong>é—®é¢˜ 2 å’Œ 3ï¼š</strong></p>

<p>è¿™æ˜¯ Windows Vista+ ç³»ç»Ÿå¯¹ã€Œå®‰è£…åŒ…ã€çš„ã€Œç‰¹æ®Šå¾…é‡ã€ï¼Œå¦‚æœä½ æ­£åœ¨åšå®‰è£…åŒ…ï¼Œé‚£ä½ åº”è¯¥ä¸åœ¨ä¹è¿™äº›ï¼›å¦‚æœä½ æ­£åœ¨åšçš„ä¸æ˜¯ã€Œå®‰è£…åŒ…ã€ï¼Œé‚£ä¹ˆå°†ç¨‹åºæ”¹åå§ï¼å»æ‰ installï¼Œå»æ‰ updateï¼Œå»æ‰ setupï¼Œä¸–ç•Œä»æ­¤æ¸…å‡€äº†ã€‚</p>

<h3 id="ç»“è®º">ç»“è®º</h3>

<ol>
  <li>å¦‚æœä½ æ­£åœ¨åšçš„æ˜¯å®‰è£…åŒ…ï¼Œé‚£ä¹ˆéµå¾ª Windows Vista+ ç³»ç»Ÿå¯¹å®‰è£…åŒ…çš„ä¸€è‡´è§„èŒƒï¼Œä¸»åŠ¨è¦æ±‚ä»¥ç®¡ç†å‘˜æƒé™æ‰§è¡Œï¼Œå¹¶åœ¨å®‰è£…ä»»åŠ¡æˆåŠŸå®Œæˆååœ¨ã€Œæ·»åŠ æˆ–åˆ é™¤ç¨‹åºã€é‡Œæ·»åŠ æ–°çš„æ¡ç›®ã€‚</li>
  <li>å¦‚æœä¸æ˜¯åœ¨åšå®‰è£…åŒ…ï¼Œé‚£ä¹ˆå°†ç¨‹åºæ”¹åèƒ½é¿å… Windows Vista+ ç³»ç»Ÿçš„è¯¯åˆ¤å¯¼è‡´çš„é—®é¢˜ã€‚</li>
</ol>
:ET