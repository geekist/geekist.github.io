I"ği<p>æœ€è¿‘æŠ½ç©ºæµè§ˆäº†ä¸€éã€ŠCOM åŸç†ä¸åº”ç”¨ã€‹ï¼Œä¸€æœ¬è€ä¹¦äº†ï¼ŒCOM æŠ€æœ¯åœ¨æˆ‘å·¥ä½œä¸­è¿ç”¨å¾—ä¸å¤šï¼Œä½†æ˜¯æ¥å£è®¾è®¡è§„èŒƒå’Œæ ‡å‡†è¿™ä¸€å¥—ä¸œè¥¿è¿˜æ˜¯èƒ½å¸¦ç»™æˆ‘ä¸€äº›æœ‰ç”¨çš„å®è·µç»éªŒå’Œå¯å‘çš„ã€‚åœ¨è¯»åˆ°ç¬¬äºŒç« ã€ŠCOM å¯¹è±¡å’Œæ¥å£ã€‹çš„æ—¶å€™ï¼Œçœ‹åˆ°è™šå‡½æ•°è¡¨çš„ä¸€äº›ç›¸å…³çŸ¥è¯†ï¼Œè¿™äº›ä¹‹å‰å€’æ˜¯ä¹Ÿéƒ½çŸ¥é“ï¼Œä½†æ˜¯ä»æ¥æ²¡æœ‰è¯•ç€è‡ªå·±æè¿°è¿‡ï¼Œæ‰€ä»¥è€è§‰å¾—ç†è§£å¾—ä¸å¤Ÿå½»åº•ï¼Œé‚£ä¹ˆâ€¦â€¦å°±è¯•ç€ç»“åˆä¸€äº›å°çš„ä»£ç æ®µæè¿°ä¸€ä¸‹çœ‹ï¼Œæƒå½“ç¬”è®°åŠ æ·±è®°å¿†ã€‚</p>

<p><em>ä»¥ä¸‹ä»£ç åŠè¿è¡Œç»“æœåŸºäº Win7_64 + GCC 4.7.2 ç¯å¢ƒï¼Œå…¶å®ƒç¯å¢ƒä¸‹å¯èƒ½ç¨‹åºè¿è¡Œç»“æœç­‰æœ‰å‡ºå…¥ï¼Œä½†æ˜¯åŸç†ç›¸é€šã€‚</em></p>

<p><strong>ç›®å½•</strong></p>

<ul id="markdown-toc">
  <li><a href="#æ— ç»§æ‰¿ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„" id="markdown-toc-æ— ç»§æ‰¿ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„">æ— ç»§æ‰¿ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„</a></li>
  <li><a href="#å•ç»§æ‰¿çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„" id="markdown-toc-å•ç»§æ‰¿çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„">å•ç»§æ‰¿çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„</a></li>
  <li><a href="#æ™®é€šå¤šç»§æ‰¿çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„" id="markdown-toc-æ™®é€šå¤šç»§æ‰¿çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„">æ™®é€šå¤šç»§æ‰¿çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„</a></li>
  <li><a href="#å•è™šç»§æ‰¿çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„" id="markdown-toc-å•è™šç»§æ‰¿çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„">å•è™šç»§æ‰¿çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„</a></li>
  <li><a href="#é’»çŸ³ç»“æ„çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„" id="markdown-toc-é’»çŸ³ç»“æ„çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„">é’»çŸ³ç»“æ„çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„</a></li>
</ul>

<h3 id="æ— ç»§æ‰¿ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„">æ— ç»§æ‰¿ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„</h3>

<p>å…ˆæ¥çœ‹çœ‹æœ‰ä¸æ²¡æœ‰è™šå‡½æ•°çš„ç±»çš„å¯¹è±¡çš„å†…å­˜ç»“æ„çš„ä¸åŒä¹‹å¤„ï¼š</p>

<p><strong>æ— è™šå‡½æ•°çš„å¯¹è±¡</strong></p>

<p>å†…å­˜ç»“æ„ï¼š</p>

<p><img src="/images/posts/cplusplus/objectwithnovirtual.png" alt="Object with no virtual function" /></p>

<p>éªŒè¯å¦‚ä¸‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="k">class</span> <span class="nc">CObj</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">CObj</span><span class="p">(</span><span class="kt">int</span> <span class="n">nData1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nData2</span><span class="p">)</span> <span class="o">:</span> <span class="n">m_nData1</span><span class="p">(</span><span class="n">nData1</span><span class="p">),</span> <span class="n">m_nData2</span><span class="p">(</span><span class="n">nData2</span><span class="p">)</span> <span class="p">{}</span>
    <span class="o">~</span><span class="n">CObj</span><span class="p">()</span> <span class="p">{}</span>

    <span class="kt">void</span> <span class="n">Func</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CObj::Func()</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>

<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">m_nData1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">m_nData2</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">CObj</span> <span class="n">obj</span><span class="p">(</span><span class="mi">11</span> <span class="p">,</span><span class="mi">22</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æ¥çœ‹çœ‹ obj çš„å®é™…å†…å­˜åˆ†å¸ƒï¼š</p>

<p><img src="/images/posts/cplusplus/objectwithnovirtual_mem.png" alt="Object with no virtual function" /></p>

<p>å°ç»“ï¼š</p>

<ul>
  <li>æ•°æ®æˆå‘˜æŒ‰å£°æ˜é¡ºåºæ’åˆ—</li>
</ul>

<p><strong>æœ‰è™šå‡½æ•°çš„å¯¹è±¡</strong></p>

<p>å†…å­˜ç»“æ„ï¼š</p>

<p><img src="/images/posts/cplusplus/objectwithvirtual.png" alt="Object with virtual functions" /></p>

<p>éªŒè¯å¦‚ä¸‹ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="k">class</span> <span class="nc">CObj</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">CObj</span><span class="p">(</span><span class="kt">int</span> <span class="n">nData1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nData2</span><span class="p">)</span> <span class="o">:</span> <span class="n">m_nData1</span><span class="p">(</span><span class="n">nData1</span><span class="p">),</span> <span class="n">m_nData2</span><span class="p">(</span><span class="n">nData2</span><span class="p">)</span> <span class="p">{}</span>
    <span class="o">~</span><span class="n">CObj</span><span class="p">()</span> <span class="p">{}</span>

    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncA</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CObj::FuncA()</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncB</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CObj::FuncB()</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>

<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">m_nData1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">m_nData2</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">CObj</span> <span class="n">obj1</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">);</span>
    <span class="n">CObj</span> <span class="n">obj2</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">22</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æ¥çœ‹çœ‹ obj1 å’Œ obj2 çš„å®é™…å†…å­˜ç»“æ„ï¼š</p>

<p><img src="/images/posts/cplusplus/objectwithvirtual_mem.png" alt="Object with virtual functions" /></p>

<p>å°ç»“ï¼š</p>

<ul>
  <li>è™šå‡½æ•°æŒ‡é’ˆåœ¨è™šè¡¨å†…æŒ‰å£°æ˜é¡ºåºæ’åˆ—</li>
</ul>

<h3 id="å•ç»§æ‰¿çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„">å•ç»§æ‰¿çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„</h3>

<p>å­ç±»è¦†ç›–çˆ¶ç±»è™šå‡½æ•°ä¹‹åè™šå‡½æ•°è¡¨çš„å˜åŒ–å¯ä»¥é€šè¿‡å¯¹æ¯”æ˜æ˜¾çš„å¾—å‡ºï¼Œè¿™å³æ˜¯å¤šæ€çš„å®ç°æœºåˆ¶ã€‚</p>

<p><strong>å­ç±»æ— è¦†ç›–çˆ¶ç±»çš„è™šå‡½æ•°</strong></p>

<p>å†…å­˜ç»“æ„ï¼š</p>

<p><img src="/images/posts/cplusplus/derivenooverride.png" alt="derive no override" /></p>

<p>éªŒè¯å¦‚ä¸‹ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="k">class</span> <span class="nc">CBase</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">CBase</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_nData1</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncA</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CBase::FuncA</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>

<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">m_nData1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">CDerive</span> <span class="o">:</span> <span class="k">public</span> <span class="n">CBase</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">CDerive</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_nData2</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncB</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CDerive::FuncB</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>

<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">m_nData2</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">CDerive</span> <span class="o">*</span><span class="n">pDerive</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CDerive</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æ¥çœ‹çœ‹ pDerive çš„å®é™…å†…å­˜ç»“æ„ï¼š</p>

<p><img src="/images/posts/cplusplus/derivenooverride_mem.png" alt="derive no override" /></p>

<p>å°ç»“ï¼š</p>

<ul>
  <li>çˆ¶ç±»æˆå‘˜åœ¨å­ç±»æˆå‘˜ä¹‹å‰</li>
  <li>çˆ¶ç±»è™šå‡½æ•°åœ¨å­ç±»è™šå‡½æ•°ä¹‹å‰</li>
</ul>

<p><strong>å­ç±»æœ‰è¦†ç›–çˆ¶ç±»çš„è™šå‡½æ•°</strong></p>

<p>å†…å­˜ç»“æ„ï¼š</p>

<p><img src="/images/posts/cplusplus/deriveoverride.png" alt="derive override" /></p>

<p>éªŒè¯å¦‚ä¸‹ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="k">class</span> <span class="nc">CBase</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">CBase</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_nData1</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncA</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CBase::FuncA</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>

<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">m_nData1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">CDerive</span> <span class="o">:</span> <span class="k">public</span> <span class="n">CBase</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">CDerive</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_nData2</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncA</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CDerive::FuncA</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>    <span class="c1">// add this line</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncB</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CDerive::FuncB</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>

<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">m_nData2</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">CDerive</span> <span class="o">*</span><span class="n">pDerive</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CDerive</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æ¥çœ‹çœ‹ pDerive çš„å®é™…å†…å­˜ç»“æ„ï¼š</p>

<p><img src="/images/posts/cplusplus/deriveoverride_mem.png" alt="derive override" /></p>

<h3 id="æ™®é€šå¤šç»§æ‰¿çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„">æ™®é€šå¤šç»§æ‰¿çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„</h3>

<p>å†…å­˜ç»“æ„ï¼š</p>

<p><img src="/images/posts/cplusplus/multiderive.png" alt="multi derive" /></p>

<p>éªŒè¯å¦‚ä¸‹ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="k">class</span> <span class="nc">CBase1</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">CBase1</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_nData1</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncA</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CBase1::FuncA</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>

<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">m_nData1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">CBase2</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">CBase2</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_nData2</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncB</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CBase2::FuncB</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>

<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">m_nData2</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">CDerive</span> <span class="o">:</span> <span class="k">public</span> <span class="n">CBase1</span><span class="p">,</span> <span class="k">public</span> <span class="n">CBase2</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">CDerive</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_nData3</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncA</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CDerive::FuncA</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncB</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CDerive::FuncB</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncC</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CDerive::FuncC</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>

<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">m_nData3</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">CDerive</span> <span class="o">*</span><span class="n">pDerive</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CDerive</span><span class="p">;</span>
    <span class="n">CBase1</span> <span class="o">*</span><span class="n">pBase1</span> <span class="o">=</span> <span class="n">pDerive</span><span class="p">;</span>
    <span class="n">CBase2</span> <span class="o">*</span><span class="n">pBase2</span> <span class="o">=</span> <span class="n">pDerive</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æ¥çœ‹çœ‹ pDeriveã€pBase1 å’Œ pBase2 åœ¨å®é™…å†…å­˜ä¸­çš„æƒ…å†µï¼š</p>

<p><img src="/images/posts/cplusplus/multiderive_mem.png" alt="multi derive" /></p>

<p>å°ç»“ï¼š</p>

<ul>
  <li>å¤šä¸ªçˆ¶ç±»çš„æˆå‘˜åœ¨å†…å­˜ä¸­æŒ‰ç»§æ‰¿æ—¶å£°æ˜çš„é¡ºåºæ’åˆ—</li>
  <li>å­ç±»æ•°æ®æˆå‘˜æ”¾åœ¨æœ€åä¸€ä¸ªçˆ¶ç±»çš„æ•°æ®æˆå‘˜ä¹‹å</li>
  <li>å­ç±»è™šå‡½æ•°åˆ—è¡¨åœ¨ç¬¬ä¸€ä¸ªè™šè¡¨ä¸­</li>
  <li>ç¬¬ä¸€å¼ è™šè¡¨ä¸­å­˜æ”¾äº†æ‰€æœ‰çš„è™šå‡½æ•°æŒ‡é’ˆï¼Œå…¶å®ƒè™šè¡¨å­˜æ”¾äº†æŸä¸ªçˆ¶ç±»çš„ï¼ˆå¯èƒ½æ˜¯è¢«è¦†ç›–åçš„ï¼‰è™šå‡½æ•°æŒ‡é’ˆ</li>
</ul>

<h3 id="å•è™šç»§æ‰¿çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„">å•è™šç»§æ‰¿çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„</h3>

<p>å†…å­˜ç»“æ„ï¼š</p>

<p><img src="/images/posts/cplusplus/virtualderive.png" alt="virtual derive" /></p>

<p>éªŒè¯å¦‚ä¸‹ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="k">class</span> <span class="nc">CBase</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">CBase</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_nData1</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncA</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CBase::FuncA</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>

<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">m_nData1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">CDerive</span> <span class="o">:</span> <span class="k">public</span> <span class="k">virtual</span> <span class="n">CBase</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">CDerive</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_nData2</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncA</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CDerive::FuncA</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncB</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CDerive::FuncB</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>

<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">m_nData2</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">CDerive</span> <span class="o">*</span><span class="n">pDerive</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CDerive</span><span class="p">;</span>
    <span class="n">CBase</span> <span class="o">*</span><span class="n">pBase</span> <span class="o">=</span> <span class="n">pDerive</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æ¥çœ‹çœ‹ pDeriveã€pBase åœ¨å®é™…å†…å­˜ä¸­çš„æƒ…å†µï¼š</p>

<p><img src="/images/posts/cplusplus/virtualderive_mem.png" alt="virtual derive" /></p>

<p>å°ç»“ï¼š</p>

<ul>
  <li>çˆ¶ç±»æ•°æ®æˆå‘˜ä¼šæ”¾åœ¨ç¬¬äºŒå¼ è™šè¡¨æŒ‡é’ˆä¹‹å</li>
  <li>ç¬¬ä¸€å¼ è™šè¡¨é‡Œå­˜æ”¾äº†æ‰€æœ‰çš„è™šå‡½æ•°æŒ‡é’ˆ</li>
</ul>

<h3 id="é’»çŸ³ç»“æ„çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„">é’»çŸ³ç»“æ„çš„ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„</h3>

<p>å†…å­˜ç»“æ„ï¼š</p>

<p><img src="/images/posts/cplusplus/diamond.png" alt="diamond derive" /></p>

<p>éªŒè¯å¦‚ä¸‹ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="k">class</span> <span class="nc">CBase</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">CBase</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_nData</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">Func</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CBase::Func</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>

<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">m_nData</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">CBase1</span> <span class="o">:</span> <span class="k">virtual</span> <span class="k">public</span> <span class="n">CBase</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">CBase1</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_nData1</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncA</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CBase1::FuncA</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>

<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">m_nData1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">CBase2</span> <span class="o">:</span> <span class="k">virtual</span> <span class="k">public</span> <span class="n">CBase</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">CBase2</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_nData2</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncB</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CBase2::FuncB</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>

<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">m_nData2</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">CDerive</span> <span class="o">:</span> <span class="k">public</span> <span class="n">CBase1</span><span class="p">,</span> <span class="k">public</span> <span class="n">CBase2</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">CDerive</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_nData3</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncA</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CDerive::FuncA</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncB</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CDerive::FuncB</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">FuncC</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"CDerive::FuncC</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>

<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">m_nData3</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">CDerive</span> <span class="o">*</span><span class="n">pDerive</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CDerive</span><span class="p">;</span>
    <span class="n">CBase</span> <span class="o">*</span><span class="n">pBase</span> <span class="o">=</span> <span class="n">pDerive</span><span class="p">;</span>
    <span class="n">CBase1</span> <span class="o">*</span><span class="n">pBase1</span> <span class="o">=</span> <span class="n">pDerive</span><span class="p">;</span>
    <span class="n">CBase2</span> <span class="o">*</span><span class="n">pBase2</span> <span class="o">=</span> <span class="n">pDerive</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æ¥çœ‹çœ‹ pDeriveã€pBaseã€pBase1 å’Œ pBase2 åœ¨å®é™…å†…å­˜ä¸­çš„æƒ…å†µï¼š</p>

<p><img src="/images/posts/cplusplus/diamond_mem.png" alt="diamond derive" /></p>

<p>å°ç»“ï¼š</p>

<ul>
  <li>ç¬¬ä¸€å¼ è™šè¡¨é‡Œæ²¡æœ‰å­˜æ”¾æ ¹çˆ¶ç±»çš„è™šå‡½æ•°æŒ‡é’ˆ</li>
</ul>
:ET